{"version":3,"file":"_state.js","names":["memoify","setMemoifyMemberStat","getInheritedDescriptor","signalify","Effects","isSignalGetter","WeakSet","isMemoGetter","getMembers","metadata","Object","hasOwn","classySolid_members","getMemberStat","name","type","members","index","findIndex","member","existingStat","newStat","applied","WeakMap","finalize","push","isSortedCustom","customSortOrder","sortMetadataMembersCustomOrder","has","add","sort","a","b","signalifyIfNeeded","obj","stat","get","Error","String","set","memoifyIfNeeded","effects__","effectifyIfNeeded","decoratorValue","value","descriptor","leafmostMemberValue","fn","effects","createEffect","call","extraInitializersCount","finalizeMembersIfLast","count","length"],"sources":["../src/_state.ts"],"sourcesContent":["import type {\n\tAnyObject,\n\tMemberStat,\n\tMetadataMembers,\n\tPropKey,\n\tClassySolidMetadata,\n\tSignalOrMemoType,\n} from './decorators/types.js'\nimport {memoify, setMemoifyMemberStat} from './signals/memoify.js'\nimport {getInheritedDescriptor} from 'lowclass/dist/getInheritedDescriptor.js'\nimport {signalify} from './signals/signalify.js'\nimport {Effects} from './mixins/Effectful.js'\n\nexport const isSignalGetter = new WeakSet<Function>()\nexport const isMemoGetter = new WeakSet<Function>()\n\nexport function getMembers(metadata: ClassySolidMetadata) {\n\tif (!Object.hasOwn(metadata, 'classySolid_members')) metadata.classySolid_members = [] // we don't extend the array from parent classes\n\treturn metadata.classySolid_members!\n}\n\nexport function getMemberStat(name: PropKey, type: SignalOrMemoType, members: MetadataMembers) {\n\tconst index = members.findIndex(member => member.name === name)\n\tconst existingStat = members[index]\n\tconst newStat: MemberStat = {type, name, applied: new WeakMap(), finalize: () => {}}\n\n\t// replace stat in the array with the latest (f.e. duplicate class members, last one wins)\n\tif (existingStat) members[index] = newStat\n\telse members.push(newStat)\n\n\treturn newStat\n}\n\nconst isSortedCustom = new WeakSet<MetadataMembers>()\n\n// This is the order we want for initializing supported types of members.\nconst customSortOrder: Record<SignalOrMemoType, number> = {\n\t'signal-field': 0,\n\t'memo-auto-accessor': 1,\n\t'memo-accessor': 1,\n\t'memo-method': 1,\n\t'effect-auto-accessor': 2,\n\t'effect-method': 2,\n}\n\n// This is the EcmaScript decorator extra initializer application order we don't want, for reference.\n// Anything in the same group is applied in source order within that group.\n// const ecmascriptSortOrder: Record<SignalOrMemoType, number> = {\n// \t'memo-method': 0,\n// \t'memo-accessor': 0,\n// \t'effect-method': 0,\n// \t'signal-field': 1,\n// \t'memo-auto-accessor': 1,\n// \t'effect-auto-accessor': 1,\n// }\n\n/**\n * Sort signal, memo, and effect members tracked in metadata in the order of\n * our custom `memberSortOrder`.\n *\n * This is so that any members that are normally initialized *after*\n * getters/setters/methods (such as signal fields, and memo fields and\n * auto-accessors) will be initialized before getters/setters/methods (memo\n * accessors and methods), otherwise they will be initialize *after*\n * getters/setters/methods due to EcmaScript decorator application order rules.\n *\n * See: https://github.com/tc39/proposal-decorators/issues/566\n */\nfunction sortMetadataMembersCustomOrder(members: MetadataMembers) {\n\t// Avoid sorting multiple times (that's why this is called in class\n\t// initializers rather than in the decorator directly).\n\tif (isSortedCustom.has(members)) return\n\tisSortedCustom.add(members)\n\n\t// Sort so that signal fields come first, then memo fields and\n\t// auto-accessors, finally memo accessors and methods.\n\tmembers.sort((a, b) => customSortOrder[a.type] - customSortOrder[b.type])\n}\n\nexport function signalifyIfNeeded(obj: AnyObject, name: PropKey, stat: MemberStat) {\n\tif (stat.applied.get(obj))\n\t\tthrow new Error(\n\t\t\t`@signal decorated member \"${String(\n\t\t\t\tname,\n\t\t\t)}\" has already been signalified. This can happen if there are duplicated class members.`,\n\t\t)\n\n\tsignalify(obj, [name, /*untrack*/ () => obj[name]]) // untrack in case obj[name] is already a signal (f.e. from a Solid Proxy)\n\n\tstat.applied.set(obj, true)\n}\n\nexport function memoifyIfNeeded(obj: AnyObject, name: PropKey, stat: MemberStat) {\n\tif (stat.applied.get(obj))\n\t\tthrow new Error(\n\t\t\t`@memo decorated member \"${String(\n\t\t\t\tname,\n\t\t\t)}\" has already been memoified. This can happen if there are duplicated class members.`,\n\t\t)\n\n\tsetMemoifyMemberStat(stat)\n\tmemoify(obj, name as keyof typeof obj)\n\n\tstat.applied.set(obj, true)\n}\n\n/** @private internal state */\nexport const effects__ = new WeakMap<AnyObject, Effects>()\n\nexport function effectifyIfNeeded(obj: AnyObject, name: PropKey, stat: MemberStat) {\n\tif (stat.applied.get(obj))\n\t\tthrow new Error(\n\t\t\t`@effect decorated member \"${String(\n\t\t\t\tname,\n\t\t\t)}\" has already been effectified. This can happen if there are duplicated class members.`,\n\t\t)\n\n\tconst decoratorValue = stat.value as Function\n\tif (!decoratorValue) throw new Error('not possible')\n\n\tconst descriptor = getInheritedDescriptor(obj, name)!\n\tconst leafmostMemberValue = stat.type === 'effect-auto-accessor' ? descriptor.get : obj[name]\n\n\t// Skip base class effectify if a subclass is overriding an effect.\n\tif (leafmostMemberValue !== decoratorValue) return\n\n\tconst fn = obj[name]\n\tif (typeof fn !== 'function') throw new Error(`@effect decorated member \"${String(name)}\" is not a function: ${fn}`)\n\n\tlet effects = effects__.get(obj)\n\tif (!effects) {\n\t\t// If the object is already an Effects instance, use it directly.\n\t\tif (obj instanceof Effects) effects__.set(obj, (effects = obj))\n\t\t// Otherwise, create a new Effects instance to manage the effects.\n\t\telse effects__.set(obj, (effects = new Effects()))\n\t}\n\n\teffects.createEffect(() => fn.call(obj))\n\n\tstat.applied.set(obj, true)\n}\n\n/**\n * Count number of extra initializers called for the given members array\n * per instance, so we know when the last one is called, to finalize all\n * members.\n */\nconst extraInitializersCount = new WeakMap<AnyObject, number>()\n\n/**\n * This finalizes memo initialization for the members tracked, in our custom\n * ordering.\n *\n * This is important because memos may depend on signals or other memos, and we\n * cannot rely on EcmaScript decorator order, or extra initializer order alone,\n * because accessor and method decorators/initializers run before field\n * decorators no matter the order in source code (give or take some details\n * regarding auto accessor ordering).\n *\n * See: https://github.com/tc39/proposal-decorators/issues/566\n */\nexport function finalizeMembersIfLast(obj: AnyObject, members: MetadataMembers) {\n\tlet count = extraInitializersCount.get(obj) ?? 0\n\textraInitializersCount.set(obj, ++count)\n\n\t// If this is not the last extra initializer called, return.\n\tif (count !== members.length) return\n\n\textraInitializersCount.set(obj, 0)\n\n\t// The last member in EcmaScript decorator extra initializer application\n\t// order has been initialized, so we can now initialize all the members we\n\t// track in our custom order.\n\tsortMetadataMembersCustomOrder(members)\n\n\t// All signal-fields, memo-fields, and memo-auto-accessors have been\n\t// initialized. Now initialize memo fields that were waiting for\n\t// those to be ready.\n\tfor (const stat of members) stat.finalize?.call(obj)\n}\n"],"mappings":"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","ignoreList":[]}