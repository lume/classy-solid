{"version":3,"file":"_state.js","names":["memoify","setMemoifyMemberStat","getInheritedDescriptor","signalify","Effects","untrack","isSignalGetter__","WeakSet","isMemoGetter__","getMembers__","metadata","Object","hasOwn","classySolid_members","getMemberStat__","name","type","members","context","index","findIndex","member","existingStat","newStat","applied","WeakMap","finalize","push","isSortedCustom","customSortOrder","sortMetadataMembersCustomOrder","has","add","sort","a","b","signalifyIfNeeded__","obj","stat","get","Error","String","reuseExistingSignal","set","memoifyIfNeeded__","private","kind","effects__","effectifyIfNeeded__","decoratedMember","value","privateMember","leafmostMember","effectFn","access","effects","ctor","constructor","autoStart","autoStartEffects","undefined","createEffect","call","stopEffects","addEffectFn","extraInitializersCount","finalizeMembersIfLast__","count","length"],"sources":["../src/_state.ts"],"sourcesContent":["import type {\n\tAnyObject,\n\tMemberStat,\n\tMetadataMembers,\n\tPropKey,\n\tClassySolidMetadata,\n\tMemberType,\n} from './decorators/types.js'\nimport {memoify, setMemoifyMemberStat} from './signals/memoify.js'\nimport {getInheritedDescriptor} from 'lowclass/dist/getInheritedDescriptor.js'\nimport {signalify} from './signals/signalify.js'\nimport {Effects} from './mixins/Effectful.js'\nimport {untrack} from 'solid-js'\n\n/** Libraries that wrap classy-solid signal accessors should add their overriding getters to this set. */\nexport const isSignalGetter__ = new WeakSet<Function>()\n/** Libraries that wrap classy-solid memo accessors should add their overriding getters to this set. */\nexport const isMemoGetter__ = new WeakSet<Function>()\n\nexport function getMembers__(metadata: ClassySolidMetadata) {\n\tif (!Object.hasOwn(metadata, 'classySolid_members')) metadata.classySolid_members = [] // we don't extend the array from parent classes\n\treturn metadata.classySolid_members!\n}\n\nexport function getMemberStat__(\n\tname: PropKey,\n\ttype: MemberType,\n\tmembers: MetadataMembers,\n\tcontext: ClassMemberDecoratorContext,\n) {\n\tconst index = members.findIndex(member => member.name === name)\n\tconst existingStat = members[index]\n\tconst newStat: MemberStat = {type, name, applied: new WeakMap(), finalize: () => {}, context}\n\n\t// replace stat in the array with the latest (f.e. duplicate class members, last one wins)\n\tif (existingStat) members[index] = newStat\n\telse members.push(newStat)\n\n\treturn newStat\n}\n\nconst isSortedCustom = new WeakSet<MetadataMembers>()\n\n// This is the order we want for initializing supported types of members.\nconst customSortOrder: Record<MemberType, number> = {\n\t'signal-field': 0,\n\t'memo-auto-accessor': 1,\n\t'memo-accessor': 1,\n\t'memo-method': 1,\n\t'effect-auto-accessor': 2,\n\t'effect-method': 2,\n}\n\n// This is the EcmaScript decorator extra initializer application order we don't want, for reference.\n// Anything in the same group is applied in source order within that group.\n// const ecmascriptSortOrder: Record<SignalOrMemoType, number> = {\n// \t'memo-method': 0,\n// \t'memo-accessor': 0,\n// \t'effect-method': 0,\n// \t'signal-field': 1,\n// \t'memo-auto-accessor': 1,\n// \t'effect-auto-accessor': 1,\n// }\n\n/**\n * Sort signal, memo, and effect members tracked in metadata in the order of\n * our custom `memberSortOrder`.\n *\n * This is so that any members that are normally initialized *after*\n * getters/setters/methods (such as signal fields, and memo fields and\n * auto-accessors) will be initialized before getters/setters/methods (memo\n * accessors and methods), otherwise they will be initialize *after*\n * getters/setters/methods due to EcmaScript decorator application order rules.\n *\n * See: https://github.com/tc39/proposal-decorators/issues/566\n */\nfunction sortMetadataMembersCustomOrder(members: MetadataMembers) {\n\t// Avoid sorting multiple times (that's why this is called in class\n\t// initializers rather than in the decorator directly).\n\tif (isSortedCustom.has(members)) return\n\tisSortedCustom.add(members)\n\n\t// Sort so that signal fields come first, then memo fields and\n\t// auto-accessors, finally memo accessors and methods.\n\tmembers.sort((a, b) => customSortOrder[a.type] - customSortOrder[b.type])\n}\n\nexport function signalifyIfNeeded__(obj: AnyObject, stat: MemberStat) {\n\tconst {name} = stat\n\n\tif (stat.applied.get(obj))\n\t\tthrow new Error(\n\t\t\t`@signal decorated member \"${String(\n\t\t\t\tname,\n\t\t\t)}\" has already been signalified. This can happen if there are duplicated class members.`,\n\t\t)\n\n\tif (!stat.reuseExistingSignal) signalify(obj, [name, untrack(() => obj[name])])\n\n\tstat.applied.set(obj, true)\n}\n\nexport function memoifyIfNeeded__(obj: AnyObject, stat: MemberStat) {\n\tconst {name, context} = stat\n\n\tif (stat.applied.get(obj))\n\t\tthrow new Error(\n\t\t\t`@memo decorated member \"${String(\n\t\t\t\tname,\n\t\t\t)}\" has already been memoified. This can happen if there are duplicated class members.`,\n\t\t)\n\n\tif (context.private && context.kind === 'getter') {\n\t\t// stat.memoGet\n\t} else {\n\t\tsetMemoifyMemberStat(stat)\n\t\tmemoify(obj, name as keyof typeof obj)\n\t}\n\n\tstat.applied.set(obj, true)\n}\n\n/** @private internal state */\nexport const effects__ = new WeakMap<AnyObject, Effects>()\n\nexport type AutoStartable = {\n\tautoStartEffects?: boolean\n}\n\nexport function effectifyIfNeeded__(obj: AnyObject, stat: MemberStat) {\n\tconst {name, context} = stat\n\n\tif (stat.applied.get(obj))\n\t\tthrow new Error(\n\t\t\t`@effect decorated member \"${String(\n\t\t\t\tname,\n\t\t\t)}\" has already been effectified. This can happen if there are duplicated class members.`,\n\t\t)\n\n\tif (context.kind !== 'method' && context.kind !== 'accessor') throw new Error('not possible')\n\n\tconst decoratedMember = stat.value as Function\n\tif (!decoratedMember) throw new Error('not possible')\n\n\t// In case of private members, there is no inheritance, so the decorated value is the member itself.\n\tconst privateMember = context.private && decoratedMember\n\n\t// Get any overriding/extending member from the prototype chain.\n\tconst leafmostMember = privateMember\n\t\t? privateMember\n\t\t: stat.type === 'effect-auto-accessor'\n\t\t? getInheritedDescriptor(obj, name)!.get // auto-accessor getter is the member (not the value)\n\t\t: obj[name] // method is both value and member\n\n\t// Skip base class effectify if a subclass is overriding an effect.\n\tif (leafmostMember !== decoratedMember) return\n\n\tconst effectFn = context.access.get(obj)\n\n\tif (typeof effectFn !== 'function')\n\t\tthrow new Error(`@effect decorated member \"${String(name)}\" is not a function: ${effectFn}`)\n\n\tlet effects = effects__.get(obj)\n\tif (!effects) {\n\t\t// If the object is already an Effects instance, use it directly.\n\t\tif (obj instanceof Effects) effects__.set(obj, (effects = obj))\n\t\t// Otherwise, create a new Effects instance to manage the effects.\n\t\telse effects__.set(obj, (effects = new Effects()))\n\t}\n\n\tconst ctor = obj.constructor as AutoStartable\n\tconst autoStart = ctor.autoStartEffects === undefined || ctor.autoStartEffects\n\n\tif (autoStart) effects.createEffect(() => effectFn.call(obj))\n\telse {\n\t\t// start stopped; effects will be added but not started yet if autoStart is false\n\t\teffects.stopEffects()\n\t\teffects.addEffectFn(() => effectFn.call(obj))\n\t}\n\n\tstat.applied.set(obj, true)\n}\n\n/**\n * Count number of extra initializers called for the given members array\n * per instance, so we know when the last one is called, to finalize all\n * members.\n */\nconst extraInitializersCount = new WeakMap<AnyObject, number>()\n\n/**\n * This finalizes memo initialization for the members tracked, in our custom\n * ordering.\n *\n * This is important because memos may depend on signals or other memos, and we\n * cannot rely on EcmaScript decorator order, or extra initializer order alone,\n * because accessor and method decorators/initializers run before field\n * decorators no matter the order in source code (give or take some details\n * regarding auto accessor ordering).\n *\n * See: https://github.com/tc39/proposal-decorators/issues/566\n */\nexport function finalizeMembersIfLast__(obj: AnyObject, members: MetadataMembers) {\n\tlet count = extraInitializersCount.get(obj) ?? 0\n\textraInitializersCount.set(obj, ++count)\n\n\t// If this is not the last extra initializer called, return.\n\tif (count !== members.length) return\n\n\textraInitializersCount.set(obj, 0)\n\n\t// The last member in EcmaScript decorator extra initializer application\n\t// order has been initialized, so we can now initialize all the members we\n\t// track in our custom order.\n\tsortMetadataMembersCustomOrder(members)\n\n\t// All signal-fields, memo-fields, and memo-auto-accessors have been\n\t// initialized. Now initialize memo fields that were waiting for\n\t// those to be ready.\n\tfor (const stat of members) stat.finalize?.call(obj)\n}\n"],"mappings":"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","ignoreList":[]}