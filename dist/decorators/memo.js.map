{"version":3,"file":"memo.js","names":["finalizeMemos","getMemberStat","getSignalsAndMemos","isPriorSignalOrMemoDefined","memoifyIfNeeded","sortSignalsMemosInMetadata","memo","_value","context","static","Error","kind","name","metadata","signalsAndMemos","stat","addInitializer"],"sources":["../../src/decorators/memo.ts"],"sourcesContent":["import type {SignalMetadata} from './types.js'\nimport {\n\tfinalizeMemos,\n\tgetMemberStat,\n\tgetSignalsAndMemos,\n\tisPriorSignalOrMemoDefined,\n\tmemoifyIfNeeded,\n\tsortSignalsMemosInMetadata,\n} from '../signals/_state.js'\n\n/**\n * A decorator that make a signal property derived from a memoized computation\n * based on other signals. Effects depending on this property will re-run when\n * the computed value changes, but not if the computed value stays the same even\n * if the dependencies changed.\n *\n * @example\n * ```ts\n * import {reactive, signal, memo} from \"classy-solid\";\n *\n * @reactive\n * class Example {\n *   @signal a = 1\n *   @signal b = 2\n *\n *   // @memo can be used on a field, getter, or accessor.\n *\n *   // Writable memo via field (requires function to have a parameter (arity > 0))\n *   @memo sum = (v?: number) => this.a + this.b\n *\n *   // Readonly memo via getter only\n *   @memo get sum2() {\n *     return this.a + this.b\n *   }\n *\n *   // Readonly memo via accessor (requires arrow function, not writable because no parameter (arity = 0))\n *   @memo accessor sum3 = () => this.a + this.b\n *\n *   // Readonly memo via method\n *   @memo sum4() {\n *     return this.a + this.b\n *   }\n *\n *   // Writable memo via getter with setter\n *   @memo get sum5() {\n *     return this.a + this.b\n *   }\n *   @memo set sum5(value: number) {\n *     // empty setter makes it writable (logic in here will be ignored if any)\n *   }\n *\n *   // The following variants are not supported yet as no runtime or TS support exists yet for the syntax.\n *\n *   // Writable memo via accessor, alternative long-hand syntax (not yet released, no runtime or TS support yet)\n *   @memo accessor sum6 { get; set } = () => this.a + this.b\n *\n *   // Readonly memo via accessor with only getter (not released yet, no runtime or TS support yet)\n *   @memo accessor sum7 { get; } = () => this.a + this.b\n *\n *   // Readonly memo via accessor with only getter, alternative syntax (not released yet, no runtime or TS support yet)\n *   @memo accessor sum8 {\n *     get() {\n *       return this.a + this.b\n *     }\n *   }\n *\n *   // Readonly memo via accessor with only getter, alternative syntax (not released yet, no runtime or TS support yet)\n *   @memo accessor sum8 {\n *     get() {\n *       return this.a + this.b\n *     }\n *     set(_v: number) {\n *       // empty setter makes it writable (logic in here will be ignored if any)\n *     }\n *   }\n * }\n *\n * const ex = new Example();\n *\n * console.log(ex.sum(), ex.sum2, ex.sum3(), ex.sum4(), ex.sum5);  // 3 3 3 3 3\n *\n * createEffect(() => {\n *   console.log(ex.sum(), ex.sum2, ex.sum3(), ex.sum4(), ex.sum5);\n * });\n *\n * ex.a = 5; // Logs: 7 7 7 7 7\n *\n * // This won't log anything since the computed memo values don't change (all still 7).\n * batch(() => {\n *   ex.a = 3;\n *   ex.b = 4;\n * })\n *\n * ex.sum(20); // Logs: 20 7 7 7 7 (only sum is updated)\n *\n * ex.sum5 = 15; // Logs: 20 7 7 7 15 (only sum5 is updated)\n *\n * ex.sum2 = 10; // Runtime error: Cannot set readonly property \"sum2\".\n * ```\n */\nexport function memo(\n\t_value:\n\t\t| undefined\n\t\t| ((val?: any) => any) // writable memo via field or method\n\t\t| (() => any) // readonly memo via field or method\n\t\t| ((val?: any) => void) // memo setter\n\t\t| (() => void) // memo getter\n\t\t| ClassAccessorDecoratorTarget<unknown, () => any> // today's auto-accessors, readonly memo\n\t\t| ClassAccessorDecoratorTarget<unknown, (val?: number) => any>, // today's auto-accessors, writable memo\n\tcontext:\n\t\t| ClassFieldDecoratorContext\n\t\t| ClassGetterDecoratorContext\n\t\t| ClassSetterDecoratorContext\n\t\t| ClassAccessorDecoratorContext\n\t\t| ClassMethodDecoratorContext,\n) {\n\tif (context.static) throw new Error('@memo is not supported on static fields yet.')\n\n\tconst {kind, name} = context\n\tconst metadata = context.metadata as SignalMetadata\n\tconst signalsAndMemos = getSignalsAndMemos(metadata)\n\n\tif (kind === 'field') {\n\t\tconst stat = getMemberStat(name, 'memo-field', signalsAndMemos)\n\n\t\tcontext.addInitializer(function () {\n\t\t\tsortSignalsMemosInMetadata(metadata)\n\t\t\tmemoifyIfNeeded(this as object, name, stat)\n\n\t\t\t// If we skipped memoifying prior memo members (accessor and method\n\t\t\t// memos) because of prior signal-fields, memo-fields, or\n\t\t\t// memo-auto-accessors, finalize those memos now.\n\t\t\tfinalizeMemos(this as object, stat, signalsAndMemos)\n\t\t})\n\t} else if (kind === 'accessor') {\n\t\tconst stat = getMemberStat(name, 'memo-auto-accessor', signalsAndMemos)\n\n\t\tcontext.addInitializer(function () {\n\t\t\tsortSignalsMemosInMetadata(metadata)\n\t\t\tmemoifyIfNeeded(this as object, name, stat, true)\n\n\t\t\t// If we skipped memoifying prior memo members (accessor and method\n\t\t\t// memos) because of prior signal-fields, memo-fields, or\n\t\t\t// memo-auto-accessors, finalize those memos now.\n\t\t\tfinalizeMemos(this as object, stat, signalsAndMemos)\n\t\t})\n\t} else if (kind === 'method') {\n\t\tconst stat = getMemberStat(name, 'memo-method', signalsAndMemos)\n\n\t\tcontext.addInitializer(function () {\n\t\t\tsortSignalsMemosInMetadata(metadata)\n\n\t\t\t// If any signal-fields, memo-fields, or memo-auto-accessors are\n\t\t\t// defined on the class (thus sorted before this memo method), skip\n\t\t\t// memoifying now because we need those to be initialized first,\n\t\t\t// then we'll memoify after that.\n\t\t\tif (isPriorSignalOrMemoDefined(this as object, name, signalsAndMemos)) return\n\n\t\t\tmemoifyIfNeeded(this as object, name, stat)\n\t\t})\n\t} else if (kind === 'getter' || kind === 'setter') {\n\t\tconst stat = getMemberStat(name, 'memo-accessor', signalsAndMemos)\n\n\t\tcontext.addInitializer(function () {\n\t\t\tsortSignalsMemosInMetadata(metadata)\n\n\t\t\t// If any signal-fields, memo-fields, or memo-auto-accessors are\n\t\t\t// defined on the class (thus sorted before this memo method), skip\n\t\t\t// memoifying now because we need those to be initialized first,\n\t\t\t// then we'll memoify after that.\n\t\t\tif (isPriorSignalOrMemoDefined(this as object, name, signalsAndMemos)) return\n\n\t\t\tmemoifyIfNeeded(this as object, name, stat)\n\t\t})\n\t}\n}\n"],"mappings":"AACA,SACCA,aAAa,EACbC,aAAa,EACbC,kBAAkB,EAClBC,0BAA0B,EAC1BC,eAAe,EACfC,0BAA0B,QACpB,sBAAsB;;AAE7B;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,OAAO,SAASC,IAAIA,CACnBC,MAO+D;AAAE;AACjEC,OAK8B,EAC7B;EACD,IAAIA,OAAO,CAACC,MAAM,EAAE,MAAM,IAAIC,KAAK,CAAC,8CAA8C,CAAC;EAEnF,MAAM;IAACC,IAAI;IAAEC;EAAI,CAAC,GAAGJ,OAAO;EAC5B,MAAMK,QAAQ,GAAGL,OAAO,CAACK,QAA0B;EACnD,MAAMC,eAAe,GAAGZ,kBAAkB,CAACW,QAAQ,CAAC;EAEpD,IAAIF,IAAI,KAAK,OAAO,EAAE;IACrB,MAAMI,IAAI,GAAGd,aAAa,CAACW,IAAI,EAAE,YAAY,EAAEE,eAAe,CAAC;IAE/DN,OAAO,CAACQ,cAAc,CAAC,YAAY;MAClCX,0BAA0B,CAACQ,QAAQ,CAAC;MACpCT,eAAe,CAAC,IAAI,EAAYQ,IAAI,EAAEG,IAAI,CAAC;;MAE3C;MACA;MACA;MACAf,aAAa,CAAC,IAAI,EAAYe,IAAI,EAAED,eAAe,CAAC;IACrD,CAAC,CAAC;EACH,CAAC,MAAM,IAAIH,IAAI,KAAK,UAAU,EAAE;IAC/B,MAAMI,IAAI,GAAGd,aAAa,CAACW,IAAI,EAAE,oBAAoB,EAAEE,eAAe,CAAC;IAEvEN,OAAO,CAACQ,cAAc,CAAC,YAAY;MAClCX,0BAA0B,CAACQ,QAAQ,CAAC;MACpCT,eAAe,CAAC,IAAI,EAAYQ,IAAI,EAAEG,IAAI,EAAE,IAAI,CAAC;;MAEjD;MACA;MACA;MACAf,aAAa,CAAC,IAAI,EAAYe,IAAI,EAAED,eAAe,CAAC;IACrD,CAAC,CAAC;EACH,CAAC,MAAM,IAAIH,IAAI,KAAK,QAAQ,EAAE;IAC7B,MAAMI,IAAI,GAAGd,aAAa,CAACW,IAAI,EAAE,aAAa,EAAEE,eAAe,CAAC;IAEhEN,OAAO,CAACQ,cAAc,CAAC,YAAY;MAClCX,0BAA0B,CAACQ,QAAQ,CAAC;;MAEpC;MACA;MACA;MACA;MACA,IAAIV,0BAA0B,CAAC,IAAI,EAAYS,IAAI,EAAEE,eAAe,CAAC,EAAE;MAEvEV,eAAe,CAAC,IAAI,EAAYQ,IAAI,EAAEG,IAAI,CAAC;IAC5C,CAAC,CAAC;EACH,CAAC,MAAM,IAAIJ,IAAI,KAAK,QAAQ,IAAIA,IAAI,KAAK,QAAQ,EAAE;IAClD,MAAMI,IAAI,GAAGd,aAAa,CAACW,IAAI,EAAE,eAAe,EAAEE,eAAe,CAAC;IAElEN,OAAO,CAACQ,cAAc,CAAC,YAAY;MAClCX,0BAA0B,CAACQ,QAAQ,CAAC;;MAEpC;MACA;MACA;MACA;MACA,IAAIV,0BAA0B,CAAC,IAAI,EAAYS,IAAI,EAAEE,eAAe,CAAC,EAAE;MAEvEV,eAAe,CAAC,IAAI,EAAYQ,IAAI,EAAEG,IAAI,CAAC;IAC5C,CAAC,CAAC;EACH;AACD","ignoreList":[]}