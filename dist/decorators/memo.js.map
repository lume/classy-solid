{"version":3,"file":"memo.js","names":["createMemo","createRoot","createWritableMemo","finalizeMembersIfLast","getMemberStat","getMembers","memoifyIfNeeded","memo","value","context","static","Error","kind","name","metadata","members","private","getterSetterMemos","getGetterSetterMemos","val","get","memos","memoFn","self","set","call","WeakMap","init","Undefined","Symbol","length","memberType","stat","finalize","addInitializer","Object","hasOwn","classySolid_getterSetterMemos","getterSetterMemoStorage"],"sources":["../../src/decorators/memo.ts"],"sourcesContent":["import {createMemo, createRoot, type Setter, type Signal} from 'solid-js'\nimport {createWritableMemo} from '@solid-primitives/memo'\nimport type {AnyObject, ClassySolidMetadata, PropKey} from './types.js'\nimport {finalizeMembersIfLast, getMemberStat, getMembers, memoifyIfNeeded} from '../_state.js'\nimport './metadata-shim.js'\n\n/**\n * A decorator that make a signal property derived from a memoized computation\n * based on other signals. Effects depending on this property will re-run when\n * the computed value changes, but not if the computed value stays the same even\n * if the dependencies changed.\n *\n * @example\n * ```ts\n * import {reactive, signal, memo} from \"classy-solid\";\n *\n * class Example {\n *   @signal a = 1\n *   @signal b = 2\n *\n *   // @memo can be used on a getter, accessor, or method, with readonly and\n *   // writable variants:\n *\n *   // Readonly memo via getter only\n *   @memo get sum1() {\n *     return this.a + this.b\n *   }\n *\n *   // Writable memo via getter with setter\n *   @memo get sum2() {\n *     return this.a + this.b\n *   }\n *   @memo set sum2(value: number) {\n *     // use an empty setter to enable writable (logic in here will be ignored if any)\n *   }\n *\n *   // Readonly memo via auto accessor (requires arrow function, not writable because no parameter (arity = 0))\n *   @memo accessor sum3 = () => this.a + this.b\n *\n *   // Writable memo via auto accessor (requires arrow function with parameter, arity > 0)\n *   // Ignore the parameter, it only enables writable memo\n *   @memo accessor sum4 = (v?: number) => this.a + this.b\n *\n *   // Readonly memo via method\n *   @memo sum5() {\n *     return this.a + this.b\n *   }\n *\n *   // Writable memo via method with parameter (arity > 0)\n *   @memo sum6(value?: number) {\n *     // Ignore the parameter, it only enables writable memo\n *     return this.a + this.b\n *   }\n *\n *   // The following variants are not supported yet as no runtime or TS support exists yet for the syntax.\n *\n *   // Writable memo via accessor, alternative long-hand syntax (not yet released, no runtime or TS support yet)\n *   @memo accessor sum6 { get; set } = () => this.a + this.b\n *\n *   // Readonly memo via accessor with only getter (not released yet, no runtime or TS support yet)\n *   @memo accessor sum7 { get; } = () => this.a + this.b\n *\n *   // Readonly memo via accessor with only getter, alternative syntax (not released yet, no runtime or TS support yet)\n *   @memo accessor sum8 {\n *     get() {\n *       return this.a + this.b\n *     }\n *   }\n *\n *   // Readonly memo via accessor with only getter, alternative syntax (not released yet, no runtime or TS support yet)\n *   @memo accessor sum8 {\n *     get() {\n *       return this.a + this.b\n *     }\n *     set(_v: number) {\n *       // empty setter makes it writable (logic in here will be ignored if any)\n *     }\n *   }\n * }\n *\n * const ex = new Example()\n *\n * console.log(ex.sum1, ex.sum2, ex.sum3(), ex.sum4(), ex.sum5(), ex.sum6()) // 3 3 3 3 3 3\n *\n * createEffect(() => {\n *   console.log(ex.sum1, ex.sum2, ex.sum3(), ex.sum4(), ex.sum5(), ex.sum6())\n * });\n *\n * ex.a = 5 // Logs: 7 7 7 7 7 7\n *\n * // This won't log anything since the computed memo values don't change (all still 7).\n * batch(() => {\n *   ex.a = 3\n *   ex.b = 4\n * })\n *\n * ex.sum2 = 20 // Logs: 20 7 7 7 7 7 (only sum2 is updated)\n *\n * ex.sum6(15) // Logs: 20 7 7 7 7 15 (only sum6 is updated)\n *\n * ex.sum1 = 10 // Runtime error: Cannot set readonly property \"sum1\".\n * ```\n */\nexport function memo(\n\tvalue:\n\t\t| ((val?: any) => any) // writable memo via method\n\t\t| (() => any) // readonly memo via method\n\t\t| ((val?: any) => void) // memo setter\n\t\t| (() => void) // memo getter\n\t\t| ClassAccessorDecoratorTarget<unknown, () => any> // today's auto-accessors, readonly memo\n\t\t| ClassAccessorDecoratorTarget<unknown, (val?: number) => any>, // today's auto-accessors, writable memo\n\tcontext:\n\t\t| ClassGetterDecoratorContext\n\t\t| ClassSetterDecoratorContext\n\t\t| ClassAccessorDecoratorContext\n\t\t| ClassMethodDecoratorContext,\n) {\n\tif (context.static) throw new Error('@memo is not supported on static fields yet.')\n\n\tconst {kind, name} = context\n\tconst metadata = context.metadata as ClassySolidMetadata\n\tconst members = getMembers(metadata)\n\n\t// Apply finalization logic to all except setters (setters are finalized\n\t// together with their getters).\n\t// By skipping setters we also avoid double-counting the getter+setter pair\n\t// in the finalizeMembersIfLast logic.\n\tif (kind === 'setter') {\n\t\tif (context.private) {\n\t\t\tconst getterSetterMemos = getGetterSetterMemos(metadata, name)\n\n\t\t\treturn function (this: unknown, val: unknown) {\n\t\t\t\tlet memo = getterSetterMemos.get(this as AnyObject)\n\t\t\t\tif (!memo)\n\t\t\t\t\tthrow new Error('Memo not initialized yet. Access the getter first (f.e. set up effects first), then write.')\n\t\t\t\tmemo![1](val)\n\t\t\t} as any // unable to make TypeScript happy about the return type here at @memo application sites\n\t\t}\n\t\treturn\n\t}\n\n\t// TODO move off of memoify() (memoifyIfNeeded()), and follow this pattern for\n\t// public members like we do here with private members.\n\tif (context.private) {\n\t\tif (kind === 'getter') {\n\t\t\tconst memos = getGetterSetterMemos(metadata, name)\n\t\t\tconst memoFn = value as () => any\n\n\t\t\treturn function (this: unknown) {\n\t\t\t\tconst self = this as AnyObject\n\t\t\t\tlet memo = memos.get(self)\n\t\t\t\tif (!memo) {\n\t\t\t\t\t// Initialize memo on first usage.\n\t\t\t\t\t// Use createRoot to detach the from any current effect or\n\t\t\t\t\t// the memo will be cleaned up when an outer effect re-runs,\n\t\t\t\t\t// stopping any effects that depend on the memo from\n\t\t\t\t\t// re-running.\n\t\t\t\t\t// https://github.com/solidjs/solid/issues/2571\n\t\t\t\t\tmemos.set(self, (memo = createRoot(() => createWritableMemo(() => memoFn.call(this)))))\n\t\t\t\t}\n\t\t\t\treturn memo[0]()\n\t\t\t}\n\t\t} else if (kind === 'accessor') {\n\t\t\tconst memos = new WeakMap<object, Signal<any>>()\n\t\t\tconst memoFn = (value as ClassAccessorDecoratorTarget<unknown, () => any>).get\n\n\t\t\tconst get = function (this: unknown) {\n\t\t\t\tconst memo = memos.get(this as AnyObject)!\n\t\t\t\treturn memo[0]()\n\t\t\t}\n\n\t\t\tconst set = function (this: unknown, val: unknown) {\n\t\t\t\tconst memo = memos.get(this as AnyObject)!\n\t\t\t\tmemo[1](val)\n\t\t\t}\n\n\t\t\tconst init = function (this: unknown, val: unknown) {\n\t\t\t\tconst self = this as AnyObject\n\t\t\t\tmemos.set(\n\t\t\t\t\tself,\n\t\t\t\t\tcreateWritableMemo(() => memoFn.call(self), val),\n\t\t\t\t)\n\t\t\t\treturn val\n\t\t\t}\n\n\t\t\treturn {get, set, init}\n\t\t} else if (kind === 'method') {\n\t\t\tconst memos = new WeakMap<object, Signal<any>>()\n\t\t\tconst memoFn = value as (val?: any) => any\n\t\t\tconst Undefined = Symbol()\n\n\t\t\treturn function (this: unknown, val: unknown = Undefined) {\n\t\t\t\tconst self = this as AnyObject\n\t\t\t\tlet memo = memos.get(self)\n\t\t\t\tif (!memo) {\n\t\t\t\t\t// Initialize memo on first usage.\n\t\t\t\t\tmemos.set(\n\t\t\t\t\t\tself,\n\t\t\t\t\t\t// Use createRoot to detach the from any current effect or\n\t\t\t\t\t\t// the memo will be cleaned up when an outer effect re-runs,\n\t\t\t\t\t\t// stopping any effects that depend on the memo from\n\t\t\t\t\t\t// re-running.\n\t\t\t\t\t\t// https://github.com/solidjs/solid/issues/2571\n\t\t\t\t\t\t(memo = createRoot(() =>\n\t\t\t\t\t\t\tmemoFn.length === 0\n\t\t\t\t\t\t\t\t? [createMemo(() => memoFn.call(self)), (() => {}) as Setter<any>]\n\t\t\t\t\t\t\t\t: createWritableMemo(() => {\n\t\t\t\t\t\t\t\t\t\tdebugger\n\t\t\t\t\t\t\t\t\t\treturn memoFn.call(self)\n\t\t\t\t\t\t\t\t  }),\n\t\t\t\t\t\t)),\n\t\t\t\t\t)\n\t\t\t\t}\n\t\t\t\treturn val === Undefined ? memo[0]() : memo[1](val)\n\t\t\t}\n\t\t}\n\t}\n\n\t// @ts-expect-error skip type checking in case of invalid kind in plain JS\n\tif (kind === 'field') throw new Error('@memo is not supported on class fields.')\n\n\tconst memberType = kind === 'accessor' ? 'memo-auto-accessor' : kind === 'method' ? 'memo-method' : 'memo-accessor'\n\n\tconst stat = getMemberStat(name, memberType, members, context)\n\n\tstat.finalize = function () {\n\t\tmemoifyIfNeeded(this as AnyObject, stat)\n\t}\n\n\tcontext.addInitializer(function () {\n\t\tfinalizeMembersIfLast(this as AnyObject, members)\n\t})\n\n\tif (kind === 'method' || kind === 'getter') stat.value = value\n\telse if (kind === 'accessor') stat.value = (value as ClassAccessorDecoratorTarget<unknown, () => void>).get\n}\n\nfunction getGetterSetterMemos(metadata: ClassySolidMetadata, name: PropKey) {\n\tif (!Object.hasOwn(metadata, 'classySolid_getterSetterMemos')) metadata.classySolid_getterSetterMemos = {}\n\tconst getterSetterMemoStorage = metadata.classySolid_getterSetterMemos!\n\tlet getterSetterMemos = getterSetterMemoStorage[name]\n\tif (!getterSetterMemos)\n\t\tmetadata.classySolid_getterSetterMemos![name] = getterSetterMemos = new WeakMap<object, Signal<any>>()\n\treturn getterSetterMemos\n}\n"],"mappings":"AAAA,SAAQA,UAAU,EAAEC,UAAU,QAAiC,UAAU;AACzE,SAAQC,kBAAkB,QAAO,wBAAwB;AAEzD,SAAQC,qBAAqB,EAAEC,aAAa,EAAEC,UAAU,EAAEC,eAAe,QAAO,cAAc;AAC9F,OAAO,oBAAoB;;AAE3B;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,OAAO,SAASC,IAAIA,CACnBC,KAM+D;AAAE;AACjEC,OAI8B,EAC7B;EACD,IAAIA,OAAO,CAACC,MAAM,EAAE,MAAM,IAAIC,KAAK,CAAC,8CAA8C,CAAC;EAEnF,MAAM;IAACC,IAAI;IAAEC;EAAI,CAAC,GAAGJ,OAAO;EAC5B,MAAMK,QAAQ,GAAGL,OAAO,CAACK,QAA+B;EACxD,MAAMC,OAAO,GAAGV,UAAU,CAACS,QAAQ,CAAC;;EAEpC;EACA;EACA;EACA;EACA,IAAIF,IAAI,KAAK,QAAQ,EAAE;IACtB,IAAIH,OAAO,CAACO,OAAO,EAAE;MACpB,MAAMC,iBAAiB,GAAGC,oBAAoB,CAACJ,QAAQ,EAAED,IAAI,CAAC;MAE9D,OAAO,UAAyBM,GAAY,EAAE;QAC7C,IAAIZ,IAAI,GAAGU,iBAAiB,CAACG,GAAG,CAAC,IAAiB,CAAC;QACnD,IAAI,CAACb,IAAI,EACR,MAAM,IAAII,KAAK,CAAC,4FAA4F,CAAC;QAC9GJ,IAAI,CAAE,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","ignoreList":[]}