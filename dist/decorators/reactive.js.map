{"version":3,"file":"reactive.js","names":["getListener","$PROXY","untrack","__propsToSignalify","__resetPropsToSignalify","__createSignalAccessor","hasOwnProperty","Object","prototype","reactive","value","context","kind","TypeError","Class","signalProps","ReactiveDecorator","constructor","args","instance","Reflect","construct","new","target","proxy","prop","propSpec","initialValue","call","PropNotFoundError","Error","String"],"sources":["../../src/decorators/reactive.ts"],"sourcesContent":["import type {AnyConstructor} from 'lowclass/dist/Constructor.js'\nimport {getListener, $PROXY, untrack} from 'solid-js'\nimport {__propsToSignalify, __resetPropsToSignalify} from './signal.js'\nimport {__createSignalAccessor} from '../signals/signalify.js'\n\nconst hasOwnProperty = Object.prototype.hasOwnProperty\n\n/**\n * A decorator that makes a class reactive, allowing it have properties\n * decorated with `@signal` to make those properties reactive Solid signals.\n *\n * Example:\n *\n * ```js\n * import {reactive, signal} from 'classy-solid'\n * import {createEffect} from 'solid-js'\n *\n * ⁣@reactive\n * class Counter {\n *   ⁣@signal count = 0\n *\n *   constructor() {\n *     setInterval(() => this.count++, 1000)\n *   }\n * }\n *\n * const counter = new Counter\n *\n * createEffect(() => {\n *   console.log('count:', counter.count)\n * })\n * ```\n */\nexport function reactive(value: AnyConstructor, context: ClassDecoratorContext | undefined): any {\n\t// context may be undefined when unsing reactive() without decorators\n\tif (typeof value !== 'function' || (context && context.kind !== 'class'))\n\t\tthrow new TypeError('The @reactive decorator is only for use on classes.')\n\n\tconst Class = value\n\n\t// For the current class decorated with @reactive, we reset the map, so that\n\t// for the next class decorated with @reactive we track only that next\n\t// class's properties that were decorated with @signal. We do this because\n\t// field decorators do not have access to the class or its prototype.\n\t//\n\t// In the future maybe we can use decorator metadata for this\n\t// (https://github.com/tc39/proposal-decorator-metadata)?\n\tconst signalProps = __propsToSignalify // grab the current value before we reset it.\n\t__resetPropsToSignalify()\n\n\tclass ReactiveDecorator extends Class {\n\t\tconstructor(...args: any[]) {\n\t\t\tlet instance!: ReactiveDecorator\n\n\t\t\t// Ensure that if we're in an effect that `new`ing a class does not\n\t\t\t// track signal reads, otherwise we'll get into an infinite loop. If\n\t\t\t// someone want to trigger an effect based on properties of the\n\t\t\t// `new`ed instance, they can explicitly read the properties\n\t\t\t// themselves in the effect, making their intent clear.\n\t\t\tif (getListener()) untrack(() => (instance = Reflect.construct(Class, args, new.target))) // super()\n\t\t\telse super(...args), (instance = this)\n\n\t\t\t// Special case for Solid proxies: if the object is already a solid proxy,\n\t\t\t// all properties are already reactive, no need to signalify.\n\t\t\t// @ts-expect-error special indexed access\n\t\t\tconst proxy = instance[$PROXY] as T\n\t\t\tif (proxy) return instance\n\n\t\t\tfor (const [prop, propSpec] of signalProps) {\n\t\t\t\tlet initialValue = propSpec.initialValue\n\n\t\t\t\t// @prod-prune\n\t\t\t\tif (!(hasOwnProperty.call(instance, prop) || hasOwnProperty.call(Class.prototype, prop)))\n\t\t\t\t\tthrow new PropNotFoundError(prop)\n\n\t\t\t\t__createSignalAccessor(instance, prop as Exclude<keyof ReactiveDecorator, number>, initialValue)\n\t\t\t}\n\n\t\t\treturn instance\n\t\t}\n\t}\n\n\treturn ReactiveDecorator\n}\n\nclass PropNotFoundError extends Error {\n\tconstructor(prop: PropertyKey) {\n\t\tsuper(\n\t\t\t`Property \"${String(\n\t\t\t\tprop,\n\t\t\t)}\" not found on instance of class decorated with \\`@reactive\\`. Did you forget to use the \\`@reactive\\` decorator on one of your classes that has a \"${String(\n\t\t\t\tprop,\n\t\t\t)}\" property decorated with \\`@signal\\`?`,\n\t\t)\n\t}\n}\n"],"mappings":"AACA,SAAQA,WAAW,EAAEC,MAAM,EAAEC,OAAO,QAAO,UAAU;AACrD,SAAQC,kBAAkB,EAAEC,uBAAuB,QAAO,aAAa;AACvE,SAAQC,sBAAsB,QAAO,yBAAyB;AAE9D,MAAMC,cAAc,GAAGC,MAAM,CAACC,SAAS,CAACF,cAAc;;AAEtD;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,OAAO,SAASG,QAAQA,CAACC,KAAqB,EAAEC,OAA0C,EAAO;EAChG;EACA,IAAI,OAAOD,KAAK,KAAK,UAAU,IAAKC,OAAO,IAAIA,OAAO,CAACC,IAAI,KAAK,OAAQ,EACvE,MAAM,IAAIC,SAAS,CAAC,qDAAqD,CAAC;EAE3E,MAAMC,KAAK,GAAGJ,KAAK;;EAEnB;EACA;EACA;EACA;EACA;EACA;EACA;EACA,MAAMK,WAAW,GAAGZ,kBAAkB,EAAC;EACvCC,uBAAuB,CAAC,CAAC;EAEzB,MAAMY,iBAAiB,SAASF,KAAK,CAAC;IACrCG,WAAWA,CAAC,GAAGC,IAAW,EAAE;MAC3B,IAAIC,QAA4B;;MAEhC;MACA;MACA;MACA;MACA;MACA,IAAInB,WAAW,CAAC,CAAC,EAAEE,OAAO,CAAC,MAAOiB,QAAQ,GAAGC,OAAO,CAACC,SAAS,CAACP,KAAK,EAAEI,IAAI,EAAEI,GAAG,CAACC,MAAM,CAAE,CAAC,EAAC;MAAA,KACrF,KAAK,CAAC,GAAGL,IAAI,CAAC,EAAGC,QAAQ,GAAG,IAAK;;MAEtC;MACA;MACA;MACA,MAAMK,KAAK,GAAGL,QAAQ,CAAClB,MAAM,CAAM;MACnC,IAAIuB,KAAK,EAAE,OAAOL,QAAQ;MAE1B,KAAK,MAAM,CAACM,IAAI,EAAEC,QAAQ,CAAC,IAAIX,WAAW,EAAE;QAC3C,IAAIY,YAAY,GAAGD,QAAQ,CAACC,YAAY;;QAExC;QACA,IAAI,EAAErB,cAAc,CAACsB,IAAI,CAACT,QAAQ,EAAEM,IAAI,CAAC,IAAInB,cAAc,CAACsB,IAAI,CAACd,KAAK,CAACN,SAAS,EAAEiB,IAAI,CAAC,CAAC,EACvF,MAAM,IAAII,iBAAiB,CAACJ,IAAI,CAAC;QAElCpB,sBAAsB,CAACc,QAAQ,EAAEM,IAAI,EAA8CE,YAAY,CAAC;MACjG;MAEA,OAAOR,QAAQ;IAChB;EACD;EAEA,OAAOH,iBAAiB;AACzB;AAEA,MAAMa,iBAAiB,SAASC,KAAK,CAAC;EACrCb,WAAWA,CAACQ,IAAiB,EAAE;IAC9B,KAAK,CACJ,aAAaM,MAAM,CAClBN,IACD,CAAC,uJAAuJM,MAAM,CAC7JN,IACD,CAAC,wCACF,CAAC;EACF;AACD","ignoreList":[]}