{"version":3,"file":"signal.js","names":["$PROXY","__getSignal","__trackPropSetAtLeastOnce","signalify","__sortSignalsMemosInMetadata","isSignalGetter","memoify","__propsToSignalify","Map","__resetPropsToSignalify","Undefined","Symbol","signal","value","context","static","Error","kind","name","InvalidSignalDecoratorError","metadata","Object","hasOwn","signalFieldsAndMemos","signalsAndMemos","stat","find","key","push","type","applied","WeakMap","addInitializer","proxy","get","set","last","findLast","_","lastStat","signalStorage","initialValue","undefined","newValue","init","initialVal","call","s","add","getOrSet","getterSetterSignals","signalsStorages","getterSetterPairCounts","pairs","queueMicrotask","MissingSignalDecoratorError","newGetter","constructor","prop","String"],"sources":["../../src/decorators/signal.ts"],"sourcesContent":["import {$PROXY} from 'solid-js'\nimport {__getSignal, __trackPropSetAtLeastOnce, __createSignalAccessor, signalify} from '../signals/signalify.js'\nimport type {PropKey, PropSpec, SignalMetadata} from './types.js'\nimport type {SignalFunction} from '../signals/createSignalFunction.js'\nimport {__sortSignalsMemosInMetadata, isSignalGetter} from '../signals/_state.js'\nimport {memoify} from '../signals/memoify.js'\n\nexport let __propsToSignalify = new Map<PropKey, PropSpec>()\n\nexport function __resetPropsToSignalify() {\n\t__propsToSignalify = new Map<PropKey, PropSpec>()\n}\n\nconst Undefined = Symbol()\n\n/**\n * @decorator\n * Decorate properties of a class with `@signal` to back them with Solid\n * signals, making them reactive. Don't forget that the class in which `@signal`\n * is used must be decorated with `@reactive`.\n *\n * Related: See the Solid.js `createSignal` API for creating signals.\n *\n * Example:\n *\n * ```js\n * import {reactive, signal} from 'classy-solid'\n * import {createEffect} from 'solid-js'\n *\n * ⁣@reactive\n * class Counter {\n *   ⁣@signal count = 0\n *\n *   constructor() {\n *     setInterval(() => this.count++, 1000)\n *   }\n * }\n *\n * const counter = new Counter\n *\n * createEffect(() => {\n *   console.log('count:', counter.count)\n * })\n * ```\n */\nexport function signal(\n\tvalue: unknown,\n\tcontext:\n\t\t| ClassFieldDecoratorContext\n\t\t| ClassGetterDecoratorContext\n\t\t| ClassSetterDecoratorContext\n\t\t| ClassAccessorDecoratorContext,\n): any {\n\tif (context.static) throw new Error('@signal is not supported on static fields yet.')\n\n\tconst {kind, name} = context\n\n\tif (!(kind === 'field' || kind === 'accessor' || kind === 'getter' || kind === 'setter'))\n\t\tthrow new InvalidSignalDecoratorError()\n\n\t// const props = __propsToSignalify\n\n\t// @prod-prune\n\t// queueReactiveDecoratorChecker(props)\n\n\tconst metadata = context.metadata as SignalMetadata\n\n\tif (!Object.hasOwn(metadata, 'signalFieldsAndMemos')) metadata.signalFieldsAndMemos = []\n\tconst signalsAndMemos = metadata.signalFieldsAndMemos!\n\n\tif (kind === 'field') {\n\t\t// if (context.private && name !== '#finalize') throw new Error('@signal is not supported on private fields yet.')\n\n\t\t// if (name === '#finalize') __propsToSignalify = new Map<PropKey, PropSpec>() // reset\n\t\t// else props.set(name, {initialValue: undefined, kind})\n\n\t\t// return function (this: object, initialValue: unknown) {\n\t\t// \tif (name === '#finalize') {\n\t\t// \t\t// Special case for Solid proxies: if the object is already a solid proxy,\n\t\t// \t\t// all properties are already reactive, no need to signalify.\n\t\t// \t\t// @ts-expect-error special indexed access\n\t\t// \t\tconst proxy = this[$PROXY] as T\n\t\t// \t\tif (proxy) return this\n\n\t\t// \t\tfor (const [prop, propSpec] of props) {\n\t\t// \t\t\tlet initialValue = propSpec.initialValue\n\n\t\t// \t\t\t// @prod-prune\n\t\t// \t\t\tif (!Object.hasOwn(this, prop)) throw new PropNotFoundError(prop)\n\n\t\t// \t\t\t__createSignalAccessor(this as any, prop, initialValue)\n\t\t// \t\t}\n\t\t// \t\treturn\n\t\t// \t}\n\n\t\t// \tprops.get(name)!.initialValue = initialValue\n\t\t// \treturn initialValue\n\t\t// }\n\n\t\tlet stat = signalsAndMemos.find(([key]) => key === name)?.[1]\n\t\tif (!stat) signalsAndMemos.push([name, (stat = {type: 'signal-field', applied: new WeakMap()})])\n\n\t\tcontext.addInitializer(function (this: unknown) {\n\t\t\t// Special case for Solid proxies: if the object is already a solid proxy,\n\t\t\t// all properties are already reactive, no need to signalify.\n\t\t\t// @ts-expect-error special indexed access\n\t\t\tconst proxy = this[$PROXY] as T\n\t\t\tif (proxy) return\n\n\t\t\t__sortSignalsMemosInMetadata(metadata)\n\n\t\t\t// __createSignalAccessor(this as any, name, value)\n\n\t\t\tif (stat.applied.get(this as object)) return\n\t\t\tsignalify(this as object, [name as keyof object, (this as object)[name as keyof object]])\n\t\t\tstat.applied.set(this as object, true)\n\n\t\t\tconst last = signalsAndMemos.findLast(\n\t\t\t\t([_, {type}]) => type === 'signal-field' || type === 'memo-field' || type === 'memo-auto-accessor',\n\t\t\t)!\n\t\t\tconst [, lastStat] = last\n\n\t\t\tif (stat !== lastStat) return\n\n\t\t\t// All signal-fields, memo-fields, and memo-auto-accessors have been\n\t\t\t// initialized. Now initialize memo fields that were waiting for\n\t\t\t// those to be ready.\n\t\t\tfor (const [key, stat] of signalsAndMemos) {\n\t\t\t\tif (!(stat.type === 'memo-accessor' || stat.type === 'memo-method') || stat.applied.get(this as object))\n\t\t\t\t\tcontinue\n\t\t\t\tmemoify(this as object, key as keyof object)\n\t\t\t}\n\t\t})\n\t} else if (kind === 'accessor') {\n\t\tconst {get, set} = value as {get: () => unknown; set: (v: unknown) => void}\n\t\tconst signalStorage = new WeakMap<object, SignalFunction<unknown>>()\n\t\tlet initialValue: unknown = undefined\n\n\t\tconst newValue = {\n\t\t\tinit: function (this: object, initialVal: unknown) {\n\t\t\t\tinitialValue = initialVal\n\t\t\t\treturn initialVal\n\t\t\t},\n\t\t\tget: function (this: object): unknown {\n\t\t\t\t__getSignal(this, signalStorage, initialValue)()\n\t\t\t\treturn get.call(this)\n\t\t\t},\n\t\t\tset: function (this: object, newValue: unknown) {\n\t\t\t\tset.call(this, newValue)\n\t\t\t\t__trackPropSetAtLeastOnce(this, name) // not needed anymore? test it\n\n\t\t\t\tconst s = __getSignal(this, signalStorage, initialValue)\n\t\t\t\ts(typeof newValue === 'function' ? () => newValue : newValue)\n\t\t\t},\n\t\t}\n\n\t\tisSignalGetter.add(newValue.get)\n\n\t\treturn newValue\n\t} else if (kind === 'getter' || kind === 'setter') {\n\t\tconst getOrSet = value as Function\n\t\tconst initialValue = Undefined\n\n\t\tif (!Object.hasOwn(metadata, 'getterSetterSignals')) metadata.getterSetterSignals = {}\n\t\tconst signalsStorages = metadata.getterSetterSignals!\n\n\t\tlet signalStorage = signalsStorages[name]\n\t\tif (!signalStorage) signalsStorages[name] = signalStorage = new WeakMap<object, SignalFunction<unknown>>()\n\n\t\tif (!Object.hasOwn(metadata, 'getterSetterPairCounts')) metadata.getterSetterPairCounts = {}\n\t\tconst pairs = metadata.getterSetterPairCounts!\n\n\t\t// Show a helpful error in case someone forgets to decorate both a getter and setter.\n\t\tqueueMicrotask(() => {\n\t\t\tif (pairs[name] !== 2) throw new MissingSignalDecoratorError(name)\n\t\t})\n\n\t\tif (kind === 'getter') {\n\t\t\tpairs[name] ??= 0\n\t\t\tpairs[name]++\n\n\t\t\tconst newGetter = function (this: object): unknown {\n\t\t\t\t__getSignal(this, signalStorage, initialValue)()\n\t\t\t\treturn getOrSet.call(this)\n\t\t\t}\n\n\t\t\tisSignalGetter.add(newGetter)\n\n\t\t\treturn newGetter\n\t\t} else {\n\t\t\tpairs[name] ??= 0\n\t\t\tpairs[name]++\n\n\t\t\treturn function (this: object, newValue: unknown) {\n\t\t\t\tgetOrSet.call(this, newValue)\n\t\t\t\t__trackPropSetAtLeastOnce(this, name)\n\n\t\t\t\tconst s = __getSignal(this, signalStorage, initialValue)\n\t\t\t\ts(typeof newValue === 'function' ? () => newValue : newValue)\n\t\t\t}\n\t\t}\n\t}\n}\n\n// let checkerQueued = false\n\n/**\n * This throws an error in some cases of an end dev forgetting to decorate a\n * class with `@reactive` if they used `@signal` on that class's fields.\n *\n * This doesn't work all the time, only when the very last class decorated is\n * missing @reactive, but something is better than nothing. There's another\n * similar check performed in the `@reactive` decorator.\n */\n// function queueReactiveDecoratorChecker(props: Map<PropKey, PropSpec>) {\n// \tif (checkerQueued) return\n// \tcheckerQueued = true\n\n// \tqueueMicrotask(() => {\n// \t\tcheckerQueued = false\n\n// \t\t// If the refs are still equal, it means @reactive did not run (forgot\n// \t\t// to decorate a class that uses @signal with @reactive).\n// \t\tif (props === __propsToSignalify) {\n// \t\t\tthrow new Error(\n// \t\t\t\t// Array.from(map.keys()) instead of [...map.keys()] because it breaks in Oculus browser.\n// \t\t\t\t`Stray @signal-decorated properties detected: ${Array.from(props.keys()).join(\n// \t\t\t\t\t', ',\n// \t\t\t\t)}. Did you forget to use the \\`@reactive\\` decorator on a class that has properties decorated with \\`@signal\\`?`,\n// \t\t\t)\n// \t\t}\n// \t})\n// }\n\n// class PropNotFoundError extends Error {\n// \tconstructor(prop: PropertyKey) {\n// \t\tsuper(\n// \t\t\t`Property \"${String(\n// \t\t\t\tprop,\n// \t\t\t)}\" not found on instance of class decorated with \\`@reactive\\`. Did you forget to use the \\`@reactive\\` decorator on one of your classes that has a \"${String(\n// \t\t\t\tprop,\n// \t\t\t)}\" property decorated with \\`@signal\\`?`,\n// \t\t)\n// \t}\n// }\n\nclass MissingSignalDecoratorError extends Error {\n\tconstructor(prop: PropertyKey) {\n\t\tsuper(\n\t\t\t`Missing @signal decorator on setter or getter for property \"${String(\n\t\t\t\tprop,\n\t\t\t)}\". The @signal decorator will only work on a getter/setter pair with *both* getter and setter decorated with @signal.`,\n\t\t)\n\t}\n}\n\nclass InvalidSignalDecoratorError extends Error {\n\tconstructor() {\n\t\tsuper('The @signal decorator is only for use on fields, getters, setters, and auto accessors.')\n\t}\n}\n"],"mappings":"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","ignoreList":[]}