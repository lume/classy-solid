{"version":3,"file":"signal.js","names":["$PROXY","getSignal__","trackPropSetAtLeastOnce__","signalify","sortSignalsMemosInMetadata","isSignalGetter","getMemberStat","finalizeMemos","getSignalsAndMemos","Undefined","Symbol","signal","value","context","static","Error","kind","name","metadata","signalsAndMemos","InvalidSignalDecoratorError","stat","addInitializer","proxy","applied","get","set","signalStorage","WeakMap","initialValue","undefined","newValue","init","initialVal","call","s","add","getOrSet","Object","hasOwn","getterSetterSignals","signalsStorages","getterSetterPairCounts","pairs","queueMicrotask","MissingSignalDecoratorError","newGetter","constructor","prop","String"],"sources":["../../src/decorators/signal.ts"],"sourcesContent":["import {$PROXY} from 'solid-js'\nimport {getSignal__, trackPropSetAtLeastOnce__, signalify} from '../signals/signalify.js'\nimport type {SignalMetadata} from './types.js'\nimport type {SignalFunction} from '../signals/createSignalFunction.js'\nimport {\n\tsortSignalsMemosInMetadata,\n\tisSignalGetter,\n\tgetMemberStat,\n\tfinalizeMemos,\n\tgetSignalsAndMemos,\n} from '../_state.js'\n\nconst Undefined = Symbol()\n\n/**\n * @decorator\n * Decorate properties of a class with `@signal` to back them with Solid\n * signals, making them reactive.\n *\n * Related: See the Solid.js `createSignal` API for creating standalone signals.\n *\n * Example:\n *\n * ```js\n * import {signal} from 'classy-solid'\n * import {createEffect} from 'solid-js'\n *\n * class Counter {\n *   â£@signal count = 0\n *\n *   constructor() {\n *     setInterval(() => this.count++, 1000)\n *   }\n * }\n *\n * const counter = new Counter()\n *\n * createEffect(() => {\n *   console.log('count:', counter.count)\n * })\n * ```\n */\nexport function signal(\n\tvalue: unknown,\n\tcontext:\n\t\t| ClassFieldDecoratorContext\n\t\t| ClassGetterDecoratorContext\n\t\t| ClassSetterDecoratorContext\n\t\t| ClassAccessorDecoratorContext,\n): any {\n\tif (context.static) throw new Error('@signal is not supported on static fields yet.')\n\n\tconst {kind, name} = context\n\tconst metadata = context.metadata as SignalMetadata\n\tconst signalsAndMemos = getSignalsAndMemos(metadata)\n\n\tif (!(kind === 'field' || kind === 'accessor' || kind === 'getter' || kind === 'setter'))\n\t\tthrow new InvalidSignalDecoratorError()\n\n\tif (kind === 'field') {\n\t\tconst stat = getMemberStat(name, 'signal-field', signalsAndMemos)\n\n\t\tcontext.addInitializer(function () {\n\t\t\t// Special case for Solid proxies: if the object is already a solid proxy,\n\t\t\t// all properties are already reactive, no need to signalify.\n\t\t\t// @ts-expect-error special indexed access\n\t\t\tconst proxy = this[$PROXY] as T\n\t\t\tif (proxy) return\n\n\t\t\tsortSignalsMemosInMetadata(metadata)\n\n\t\t\tif (stat.applied.get(this as object)) return\n\t\t\tsignalify(this as object, [name as keyof object, (this as object)[name as keyof object]])\n\t\t\tstat.applied.set(this as object, true)\n\n\t\t\t// If we skipped memoifying prior memo members (accessor and method\n\t\t\t// memos) because of prior signal-fields, memo-fields, or\n\t\t\t// memo-auto-accessors, finalize those memos now.\n\t\t\tfinalizeMemos(this as object, stat, signalsAndMemos)\n\t\t})\n\t} else if (kind === 'accessor') {\n\t\tconst {get, set} = value as {get: () => unknown; set: (v: unknown) => void}\n\t\tconst signalStorage = new WeakMap<object, SignalFunction<unknown>>()\n\t\tlet initialValue: unknown = undefined\n\n\t\tconst newValue = {\n\t\t\tinit: function (this: object, initialVal: unknown) {\n\t\t\t\tinitialValue = initialVal\n\t\t\t\treturn initialVal\n\t\t\t},\n\t\t\tget: function (this: object): unknown {\n\t\t\t\tgetSignal__(this, signalStorage, initialValue)()\n\t\t\t\treturn get.call(this)\n\t\t\t},\n\t\t\tset: function (this: object, newValue: unknown) {\n\t\t\t\tset.call(this, newValue)\n\t\t\t\ttrackPropSetAtLeastOnce__(this, name) // not needed anymore? test it\n\n\t\t\t\tconst s = getSignal__(this, signalStorage, initialValue)\n\t\t\t\ts(typeof newValue === 'function' ? () => newValue : newValue)\n\t\t\t},\n\t\t}\n\n\t\tisSignalGetter.add(newValue.get)\n\n\t\treturn newValue\n\t} else if (kind === 'getter' || kind === 'setter') {\n\t\tconst getOrSet = value as Function\n\t\tconst initialValue = Undefined\n\n\t\tif (!Object.hasOwn(metadata, 'getterSetterSignals')) metadata.getterSetterSignals = {}\n\t\tconst signalsStorages = metadata.getterSetterSignals!\n\n\t\tlet signalStorage = signalsStorages[name]\n\t\tif (!signalStorage) signalsStorages[name] = signalStorage = new WeakMap<object, SignalFunction<unknown>>()\n\n\t\tif (!Object.hasOwn(metadata, 'getterSetterPairCounts')) metadata.getterSetterPairCounts = {}\n\t\tconst pairs = metadata.getterSetterPairCounts!\n\n\t\t// Show a helpful error in case someone forgets to decorate both a getter and setter.\n\t\tqueueMicrotask(() => {\n\t\t\tif (pairs[name] !== 2) throw new MissingSignalDecoratorError(name)\n\t\t})\n\n\t\tif (kind === 'getter') {\n\t\t\tpairs[name] ??= 0\n\t\t\tpairs[name]++\n\n\t\t\tconst newGetter = function (this: object): unknown {\n\t\t\t\tgetSignal__(this, signalStorage, initialValue)()\n\t\t\t\treturn getOrSet.call(this)\n\t\t\t}\n\n\t\t\tisSignalGetter.add(newGetter)\n\n\t\t\treturn newGetter\n\t\t} else {\n\t\t\tpairs[name] ??= 0\n\t\t\tpairs[name]++\n\n\t\t\treturn function (this: object, newValue: unknown) {\n\t\t\t\tgetOrSet.call(this, newValue)\n\t\t\t\ttrackPropSetAtLeastOnce__(this, name)\n\n\t\t\t\tconst s = getSignal__(this, signalStorage, initialValue)\n\t\t\t\ts(typeof newValue === 'function' ? () => newValue : newValue)\n\t\t\t}\n\t\t}\n\t}\n}\n\nclass MissingSignalDecoratorError extends Error {\n\tconstructor(prop: PropertyKey) {\n\t\tsuper(\n\t\t\t`Missing @signal decorator on setter or getter for property \"${String(\n\t\t\t\tprop,\n\t\t\t)}\". The @signal decorator will only work on a getter/setter pair with *both* getter and setter decorated with @signal.`,\n\t\t)\n\t}\n}\n\nclass InvalidSignalDecoratorError extends Error {\n\tconstructor() {\n\t\tsuper('The @signal decorator is only for use on fields, getters, setters, and auto accessors.')\n\t}\n}\n"],"mappings":"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","ignoreList":[]}