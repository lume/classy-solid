{"version":3,"file":"signal.js","names":["$PROXY","__getSignal","__trackPropSetAtLeastOnce","__createSignalAccessor","isSignalGetter","__propsToSignalify","Map","__resetPropsToSignalify","Undefined","Symbol","signal","value","context","kind","name","metadata","props","static","Error","queueReactiveDecoratorChecker","private","set","initialValue","undefined","proxy","prop","propSpec","Object","hasOwn","PropNotFoundError","get","signalStorage","WeakMap","newValue","init","initialVal","call","s","add","getOrSet","signalStoragesPerProp","signalsStorages","getterSetterPairs","pairs","queueMicrotask","MissingDecoratorError","newGetter","InvalidDecorationError","checkerQueued","Array","from","keys","join","constructor","String"],"sources":["../../src/decorators/signal.ts"],"sourcesContent":["import {$PROXY} from 'solid-js'\nimport {__getSignal, __trackPropSetAtLeastOnce, __createSignalAccessor, isSignalGetter} from '../signals/signalify.js'\nimport type {PropKey, PropSpec} from './types.js'\nimport type {SignalFunction} from '../signals/createSignalFunction.js'\n\nexport let __propsToSignalify = new Map<PropKey, PropSpec>()\n\nexport function __resetPropsToSignalify() {\n\t__propsToSignalify = new Map<PropKey, PropSpec>()\n}\n\nconst Undefined = Symbol()\n\ntype SignalStorages = Record<PropKey, WeakMap<object, SignalFunction<unknown>> | undefined>\n\n/**\n * @decorator\n * Decorate properties of a class with `@signal` to back them with Solid\n * signals, making them reactive. Don't forget that the class in which `@signal`\n * is used must be decorated with `@reactive`.\n *\n * Related: See the Solid.js `createSignal` API for creating signals.\n *\n * Example:\n *\n * ```js\n * import {reactive, signal} from 'classy-solid'\n * import {createEffect} from 'solid-js'\n *\n * ⁣@reactive\n * class Counter {\n *   ⁣@signal count = 0\n *\n *   constructor() {\n *     setInterval(() => this.count++, 1000)\n *   }\n * }\n *\n * const counter = new Counter\n *\n * createEffect(() => {\n *   console.log('count:', counter.count)\n * })\n * ```\n */\nexport function signal(\n\tvalue: unknown,\n\tcontext:\n\t\t| ClassFieldDecoratorContext\n\t\t| ClassGetterDecoratorContext\n\t\t| ClassSetterDecoratorContext\n\t\t| ClassAccessorDecoratorContext,\n): any {\n\tconst {kind, name, metadata} = context\n\tconst props = __propsToSignalify\n\n\tif (context.static) throw new Error('@signal is not supported on static fields yet.')\n\n\t// @prod-prune\n\tqueueReactiveDecoratorChecker(props)\n\n\tif (kind === 'field') {\n\t\tif (context.private && name !== '#finalize') throw new Error('@signal is not supported on private fields yet.')\n\n\t\tif (name === '#finalize') __propsToSignalify = new Map<PropKey, PropSpec>() // reset\n\t\telse props.set(name, {initialValue: undefined, kind})\n\n\t\treturn function (this: object, initialValue: unknown) {\n\t\t\tif (name === '#finalize') {\n\t\t\t\t// Special case for Solid proxies: if the object is already a solid proxy,\n\t\t\t\t// all properties are already reactive, no need to signalify.\n\t\t\t\t// @ts-expect-error special indexed access\n\t\t\t\tconst proxy = this[$PROXY] as T\n\t\t\t\tif (proxy) return this\n\n\t\t\t\tfor (const [prop, propSpec] of props) {\n\t\t\t\t\tlet initialValue = propSpec.initialValue\n\n\t\t\t\t\t// @prod-prune\n\t\t\t\t\tif (!Object.hasOwn(this, prop)) throw new PropNotFoundError(prop)\n\n\t\t\t\t\t__createSignalAccessor(this as any, prop, initialValue)\n\t\t\t\t}\n\t\t\t\treturn\n\t\t\t}\n\n\t\t\tprops.get(name)!.initialValue = initialValue\n\t\t\treturn initialValue\n\t\t}\n\t} else if (kind === 'accessor') {\n\t\tconst {get, set} = value as {get: () => unknown; set: (v: unknown) => void}\n\t\tconst signalStorage = new WeakMap<object, SignalFunction<unknown>>()\n\t\tlet initialValue: unknown = undefined\n\n\t\tconst newValue = {\n\t\t\tinit: function (this: object, initialVal: unknown) {\n\t\t\t\tinitialValue = initialVal\n\t\t\t\treturn initialVal\n\t\t\t},\n\t\t\tget: function (this: object): unknown {\n\t\t\t\t__getSignal(this, signalStorage, initialValue)()\n\t\t\t\treturn get.call(this)\n\t\t\t},\n\t\t\tset: function (this: object, newValue: unknown) {\n\t\t\t\tset.call(this, newValue)\n\t\t\t\t__trackPropSetAtLeastOnce(this, name) // not needed anymore? test it\n\n\t\t\t\tconst s = __getSignal(this, signalStorage, initialValue)\n\t\t\t\ts(typeof newValue === 'function' ? () => newValue : newValue)\n\t\t\t},\n\t\t}\n\n\t\tisSignalGetter.add(newValue.get)\n\n\t\treturn newValue\n\t} else if (kind === 'getter' || kind === 'setter') {\n\t\tconst getOrSet = value as Function\n\t\tconst initialValue = Undefined\n\n\t\tif (!Object.hasOwn(metadata, 'signalStoragesPerProp')) metadata.signalStoragesPerProp = {}\n\t\tconst signalsStorages = metadata.signalStoragesPerProp as SignalStorages\n\n\t\tlet signalStorage = signalsStorages[name]\n\t\tif (!signalStorage) signalsStorages[name] = signalStorage = new WeakMap<object, SignalFunction<unknown>>()\n\n\t\tif (!Object.hasOwn(metadata, 'getterSetterPairs')) metadata.getterSetterPairs = {}\n\t\tconst pairs = metadata.getterSetterPairs as {[key: PropKey]: 0 | 1 | 2}\n\n\t\t// Show a helpful error in case someone forgets to decorate both a getter and setter.\n\t\tqueueMicrotask(() => {\n\t\t\tif (pairs[name] !== 2) throw new MissingDecoratorError(name)\n\t\t})\n\n\t\tif (kind === 'getter') {\n\t\t\tpairs[name] ??= 0\n\t\t\tpairs[name]++\n\n\t\t\tconst newGetter = function (this: object): unknown {\n\t\t\t\t__getSignal(this, signalStorage, initialValue)()\n\t\t\t\treturn getOrSet.call(this)\n\t\t\t}\n\n\t\t\tisSignalGetter.add(newGetter)\n\n\t\t\treturn newGetter\n\t\t} else {\n\t\t\tpairs[name] ??= 0\n\t\t\tpairs[name]++\n\n\t\t\treturn function (this: object, newValue: unknown) {\n\t\t\t\tgetOrSet.call(this, newValue)\n\t\t\t\t__trackPropSetAtLeastOnce(this, name)\n\n\t\t\t\tconst s = __getSignal(this, signalStorage, initialValue)\n\t\t\t\ts(typeof newValue === 'function' ? () => newValue : newValue)\n\t\t\t}\n\t\t}\n\t} else throw new InvalidDecorationError()\n}\n\nlet checkerQueued = false\n\n/**\n * This throws an error in some cases of an end dev forgetting to decorate a\n * class with `@reactive` if they used `@signal` on that class's fields.\n *\n * This doesn't work all the time, only when the very last class decorated is\n * missing @reactive, but something is better than nothing. There's another\n * similar check performed in the `@reactive` decorator.\n */\nfunction queueReactiveDecoratorChecker(props: Map<PropKey, PropSpec>) {\n\tif (checkerQueued) return\n\tcheckerQueued = true\n\n\tqueueMicrotask(() => {\n\t\tcheckerQueued = false\n\n\t\t// If the refs are still equal, it means @reactive did not run (forgot\n\t\t// to decorate a class that uses @signal with @reactive).\n\t\tif (props === __propsToSignalify) {\n\t\t\tthrow new Error(\n\t\t\t\t// Array.from(map.keys()) instead of [...map.keys()] because it breaks in Oculus browser.\n\t\t\t\t`Stray @signal-decorated properties detected: ${Array.from(props.keys()).join(\n\t\t\t\t\t', ',\n\t\t\t\t)}. Did you forget to use the \\`@reactive\\` decorator on a class that has properties decorated with \\`@signal\\`?`,\n\t\t\t)\n\t\t}\n\t})\n}\n\nclass PropNotFoundError extends Error {\n\tconstructor(prop: PropertyKey) {\n\t\tsuper(\n\t\t\t`Property \"${String(\n\t\t\t\tprop,\n\t\t\t)}\" not found on instance of class decorated with \\`@reactive\\`. Did you forget to use the \\`@reactive\\` decorator on one of your classes that has a \"${String(\n\t\t\t\tprop,\n\t\t\t)}\" property decorated with \\`@signal\\`?`,\n\t\t)\n\t}\n}\n\nclass MissingDecoratorError extends Error {\n\tconstructor(prop: PropertyKey) {\n\t\tsuper(\n\t\t\t`Missing @signal decorator on setter or getter for property \"${String(\n\t\t\t\tprop,\n\t\t\t)}\". The @signal decorator will only work on a getter/setter pair with *both* getter and setter decorated with @signal.`,\n\t\t)\n\t}\n}\n\nclass InvalidDecorationError extends Error {\n\tconstructor() {\n\t\tsuper('The @signal decorator is only for use on fields, getters, setters, and auto accessors.')\n\t}\n}\n"],"mappings":"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","ignoreList":[]}