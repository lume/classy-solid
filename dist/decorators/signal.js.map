{"version":3,"file":"signal.js","names":["propsToSignalify","Map","accessKey","getKey","Error","Symbol","getPropsToSignalify","key","resetPropsToSignalify","signal","args","_","kind","name","private","isPrivate","static","isStatic","props","set","initialValue","undefined","get","queueReactiveDecoratorChecker","checkerQueued","queueMicrotask","Array","from","keys","join"],"sources":["../../src/decorators/signal.ts"],"sourcesContent":["import type {DecoratorArgs, PropKey, PropSpec} from './types.js'\n\nlet propsToSignalify = new Map<PropKey, PropSpec>()\nlet accessKey: symbol | null = null\n\n/**\n * Provides a key for accessing internal APIs. If any other module tries to get\n * this, an error will be thrown, and signal and reactive decorators will not\n * work.\n */\nexport function getKey() {\n\tif (accessKey) throw new Error('Attempted use of classy-solid internals.')\n\taccessKey = Symbol()\n\treturn accessKey\n}\n\n/**\n * This function provides propsToSignalify to only one external module\n * (reactive.ts). The purpose of this is to keep the API private for reactive.ts\n * only, otherwise an error will be thrown that breaks signal/reactive\n * functionality.\n */\nexport function getPropsToSignalify(key: symbol) {\n\tif (key !== accessKey) throw new Error('Attempted use of classy-solid internals.')\n\treturn propsToSignalify\n}\n\n/**\n * Only the module that first gets the key can call this function (it should be\n * reactive.ts)\n */\nexport function resetPropsToSignalify(key: symbol) {\n\tif (key !== accessKey) throw new Error('Attempted use of classy-solid internals.')\n\tpropsToSignalify = new Map<PropKey, PropSpec>()\n}\n\n/**\n * @decorator\n * Decorate properties of a class with `@signal` to back them with Solid\n * signals, making them reactive. Don't forget that the class in which `@signal`\n * is used must be decorated with `@reactive`.\n *\n * Example:\n *\n * > Note in the following example that `\\@` should be written as `@` without\n * the back slash. The back slash prevents JSDoc parsing errors in this comment\n * in TypeScript.  https://github.com/microsoft/TypeScript/issues/47679\n *\n * ```js\n * import {reactive, signal} from 'classy-solid'\n * import {createEffect} from 'solid-js'\n *\n * \\@reactive\n * class Counter {\n *   \\@signal count = 0\n *\n *   constructor() {\n *     setInterval(() => this.count++, 1000)\n *   }\n * }\n *\n * const counter = new Counter\n *\n * createEffect(() => {\n *   console.log('count:', counter.count)\n * })\n * ```\n */\nexport function signal(...args: any[]): any {\n\tconst [_, {kind, name, private: isPrivate, static: isStatic}] = args as DecoratorArgs\n\tconst props = propsToSignalify\n\n\tif (isPrivate) throw new Error('@signal is not supported on private fields yet.')\n\tif (isStatic) throw new Error('@signal is not supported on static fields yet.')\n\n\tif (kind === 'field') {\n\t\tprops.set(name, {initialValue: undefined})\n\t\treturn function (this: object, initialValue: unknown) {\n\t\t\tprops.get(name)!.initialValue = initialValue\n\t\t\treturn initialValue\n\t\t}\n\t} else if (kind === 'accessor') {\n\t\tthrow new Error('@signal not supported on `accessor` fields yet.')\n\t} else if (kind === 'getter' || kind === 'setter') {\n\t\tprops.set(name, {initialValue: undefined})\n\t} else {\n\t\tthrow new Error('The @signal decorator is only for use on fields, accessors, getters, and setters.')\n\t}\n\n\t// @prod-prune\n\tqueueReactiveDecoratorChecker(props)\n}\n\nlet checkerQueued = false\n\n/**\n * This throws an error in some cases of an end dev forgetting to decorate a\n * class with @reactive if they used @signal on that class's fields.\n *\n * This doesn't work all the time, only when the very last class decorated is\n * missing @reactive, but something is better than nothing. There's another\n * similar check performed in the @reactive decorator.\n */\nfunction queueReactiveDecoratorChecker(props: Map<PropKey, PropSpec>) {\n\tif (checkerQueued) return\n\tcheckerQueued = true\n\n\tqueueMicrotask(() => {\n\t\tcheckerQueued = false\n\n\t\t// If the refs are still equal, it means @reactive did not run (forgot\n\t\t// to decorate a class that uses @signal with @reactive).\n\t\tif (props === propsToSignalify) {\n\t\t\tthrow new Error(\n\t\t\t\t// Array.from(map.keys()) instead of [...map.keys()] because it breaks in Oculus browser.\n\t\t\t\t`Stray @signal-decorated properties detected: ${Array.from(props.keys()).join(\n\t\t\t\t\t', ',\n\t\t\t\t)}. Did you forget to use the \\`@reactive\\` decorator on a class that has properties decorated with \\`@signal\\`?`,\n\t\t\t)\n\t\t}\n\t})\n}\n"],"mappings":"AAEA,IAAIA,gBAAgB,GAAG,IAAIC,GAAG,CAAoB,CAAC;AACnD,IAAIC,SAAwB,GAAG,IAAI;;AAEnC;AACA;AACA;AACA;AACA;AACA,OAAO,SAASC,MAAMA,CAAA,EAAG;EACxB,IAAID,SAAS,EAAE,MAAM,IAAIE,KAAK,CAAC,0CAA0C,CAAC;EAC1EF,SAAS,GAAGG,MAAM,CAAC,CAAC;EACpB,OAAOH,SAAS;AACjB;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA,OAAO,SAASI,mBAAmBA,CAACC,GAAW,EAAE;EAChD,IAAIA,GAAG,KAAKL,SAAS,EAAE,MAAM,IAAIE,KAAK,CAAC,0CAA0C,CAAC;EAClF,OAAOJ,gBAAgB;AACxB;;AAEA;AACA;AACA;AACA;AACA,OAAO,SAASQ,qBAAqBA,CAACD,GAAW,EAAE;EAClD,IAAIA,GAAG,KAAKL,SAAS,EAAE,MAAM,IAAIE,KAAK,CAAC,0CAA0C,CAAC;EAClFJ,gBAAgB,GAAG,IAAIC,GAAG,CAAoB,CAAC;AAChD;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,OAAO,SAASQ,MAAMA,CAAC,GAAGC,IAAW,EAAO;EAC3C,MAAM,CAACC,CAAC,EAAE;IAACC,IAAI;IAAEC,IAAI;IAAEC,OAAO,EAAEC,SAAS;IAAEC,MAAM,EAAEC;EAAQ,CAAC,CAAC,GAAGP,IAAqB;EACrF,MAAMQ,KAAK,GAAGlB,gBAAgB;EAE9B,IAAIe,SAAS,EAAE,MAAM,IAAIX,KAAK,CAAC,iDAAiD,CAAC;EACjF,IAAIa,QAAQ,EAAE,MAAM,IAAIb,KAAK,CAAC,gDAAgD,CAAC;EAE/E,IAAIQ,IAAI,KAAK,OAAO,EAAE;IACrBM,KAAK,CAACC,GAAG,CAACN,IAAI,EAAE;MAACO,YAAY,EAAEC;IAAS,CAAC,CAAC;IAC1C,OAAO,UAAwBD,YAAqB,EAAE;MACrDF,KAAK,CAACI,GAAG,CAACT,IAAI,CAAC,CAAEO,YAAY,GAAGA,YAAY;MAC5C,OAAOA,YAAY;IACpB,CAAC;EACF,CAAC,MAAM,IAAIR,IAAI,KAAK,UAAU,EAAE;IAC/B,MAAM,IAAIR,KAAK,CAAC,iDAAiD,CAAC;EACnE,CAAC,MAAM,IAAIQ,IAAI,KAAK,QAAQ,IAAIA,IAAI,KAAK,QAAQ,EAAE;IAClDM,KAAK,CAACC,GAAG,CAACN,IAAI,EAAE;MAACO,YAAY,EAAEC;IAAS,CAAC,CAAC;EAC3C,CAAC,MAAM;IACN,MAAM,IAAIjB,KAAK,CAAC,mFAAmF,CAAC;EACrG;;EAEA;EACAmB,6BAA6B,CAACL,KAAK,CAAC;AACrC;AAEA,IAAIM,aAAa,GAAG,KAAK;;AAEzB;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,SAASD,6BAA6BA,CAACL,KAA6B,EAAE;EACrE,IAAIM,aAAa,EAAE;EACnBA,aAAa,GAAG,IAAI;EAEpBC,cAAc,CAAC,MAAM;IACpBD,aAAa,GAAG,KAAK;;IAErB;IACA;IACA,IAAIN,KAAK,KAAKlB,gBAAgB,EAAE;MAC/B,MAAM,IAAII,KAAK;MACd;MACC,gDAA+CsB,KAAK,CAACC,IAAI,CAACT,KAAK,CAACU,IAAI,CAAC,CAAC,CAAC,CAACC,IAAI,CAC5E,IACD,CAAE,gHACH,CAAC;IACF;EACD,CAAC,CAAC;AACH"}