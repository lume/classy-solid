{"version":3,"file":"Effectful.js","names":["createEffect","createRoot","getOwner","runWithOwner","isInstance","Symbol","Effectful","Base","prototype","Error","EffectfulClass","effectFunctions","started","fn","startEffects","addEffectFn","push","isRestarting","stopEffects","dispose","clearEffects","owner","#createEffect","Object","defineProperty","hasInstance","value","instanceCheck","obj","Effects"],"sources":["../../src/mixins/Effectful.ts"],"sourcesContent":["import {type Owner, createEffect, createRoot, getOwner, runWithOwner} from 'solid-js'\nimport type {AnyConstructor} from 'lowclass/dist/Constructor.js'\n\nconst isInstance = Symbol()\n\n/**\n * @class Effectful -\n *\n * `mixin`\n *\n * Create Solid.js effects using `this.createEffect(fn)` and easily stop them\n * all by calling `this.stopEffects()`.\n *\n * Example:\n *\n * ```js\n * import {signal} from 'classy-solid'\n * import {foo} from 'somewhere'\n * import {BaseClass} from 'some-lib'\n *\n * class MyClass extends Effectful(BaseClass) {\n *   @signal bar = 0\n *\n *   constructor() {\n *     super()\n *\n *     // Log `foo` and `bar` any time either of them change.\n *     this.createEffect(() => {\n *       console.log('foo, bar:', foo(), this.bar)\n *     })\n *\n *     // Log only `bar` any time it changes.\n *     this.createEffect(() => {\n *       console.log('bar:', this.bar)\n *     })\n *   }\n *\n *   dispose() {\n *     // Later, stop both of the effects.\n *     this.stopEffects()\n *   }\n * }\n * ```\n *\n * This pairs nicely with the `@effect` decorator. The previous example could be\n * rewritten as:\n *\n * ```js\n * import {signal, effect} from 'classy-solid'\n * import {foo} from 'somewhere'\n * import {BaseClass} from 'some-lib'\n *\n * class MyClass extends Effectful(BaseClass) {\n *   @signal bar = 0\n *\n *   @effect logFooBar() {\n *     console.log('foo, bar:', foo(), this.bar)\n *   }\n *\n *   @effect logBar() {\n *     console.log('bar:', this.bar)\n *   }\n *\n *   dispose() {\n *     // Later, stop both of the effects.\n *     this.stopEffects()\n *   }\n * }\n * ```\n */\nexport function Effectful<T extends AnyConstructor>(Base: T) {\n\tif (Base.prototype instanceof Effectful)\n\t\tthrow new Error('Class already extends Effectful, no need to apply the mixin again.')\n\n\tclass EffectfulClass extends Base {\n\t\t#effectFunctions: Array<() => void> = []\n\t\t#started = true\n\n\t\t/**\n\t\t * Create a Solid.js effect. The difference from regular\n\t\t * `createEffect()` is that `this` tracks the effects created, so that\n\t\t * they can all be stopped with `this.stopEffects()`.\n\t\t */\n\t\tcreateEffect(fn: () => void) {\n\t\t\tthis.startEffects()\n\t\t\tthis.#createEffect(fn)\n\t\t}\n\n\t\t/**\n\t\t * Adds an effect function to the list of tracked effects without\n\t\t * starting it. This is useful for adding an effect, then using\n\t\t * `startEffects()` later to start all effects at once.\n\t\t *\n\t\t * The `@effect` decorator uses this internally when its `autoStart`\n\t\t * option is set to `false`.\n\t\t */\n\t\taddEffectFn(fn: () => void) {\n\t\t\tthis.#effectFunctions.push(fn)\n\t\t}\n\n\t\t#isRestarting = false\n\n\t\t/**\n\t\t * Start all effects again. This will recreate all effects that were\n\t\t * previously created with `createEffect()` and stopped with `stopEffects()`.\n\t\t *\n\t\t * Example with a custom element class using the @effect decorator:\n\t\t *\n\t\t * ```ts\n\t\t * const [someSignal, setSomeSignal] = createSignal(0)\n\t\t *\n\t\t * class MyElement extends Effectful(HTMLElement) {\n\t\t *   @effect logSignal() {\n\t\t *     console.log('someSignal:', someSignal())\n\t\t *   }\n\t\t *\n\t\t *   connectedCallback() {\n\t\t *     this.startEffects()\n\t\t *   }\n\t\t *\n\t\t *   disconnectedCallback() {\n\t\t *     this.stopEffects()\n\t\t *   }\n\t\t * }\n\t\t * ```\n\t\t *\n\t\t * The logging of `someSignal` will happen any time `someSignal` changes\n\t\t * only while the element is connected, and but not when it is\n\t\t * disconnected.\n\t\t */\n\t\tstartEffects() {\n\t\t\tif (this.#started) return\n\t\t\tthis.#started = true\n\n\t\t\t// Restart all stored effect functions\n\t\t\tthis.#isRestarting = true\n\t\t\ttry {\n\t\t\t\tfor (const fn of this.#effectFunctions) this.#createEffect(fn)\n\t\t\t} finally {\n\t\t\t\tthis.#isRestarting = false\n\t\t\t}\n\t\t}\n\n\t\t/**\n\t\t * Stop all of the effects that were created.\n\t\t */\n\t\tstopEffects() {\n\t\t\tif (!this.#started) return\n\t\t\tthis.#started = false\n\n\t\t\tthis.#dispose?.()\n\t\t}\n\n\t\t/**\n\t\t * Stop all effects and clear the stored effect functions. After calling\n\t\t * this, `startEffects()` will not restart any effects because there are\n\t\t * none stored. This is useful for cleanup scenarios where you'll make\n\t\t * new effects using `this.createEffect()` instead of restarting old\n\t\t * ones, namely for backwards compatibility for example with custom\n\t\t * elements that may be disconnected and reconnected to the DOM and\n\t\t * currently call `this.createEffect()` in connectedCallback. Example:\n\t\t *\n\t\t * ```ts\n\t\t * class MyElement extends Effectful(HTMLElement) {\n\t\t *   connectedCallback() {\n\t\t *     // Create any number of effects on connect.\n\t\t *     this.createEffect(() => {...})\n\t\t *     this.createEffect(() => {...})\n\t\t *     this.createEffect(() => {...})\n\t\t *   }\n\t\t *\n\t\t *   disconnectedCallback() {\n\t\t *     // Clean up all effects on disconnect.\n\t\t *     this.clearEffects()\n\t\t *   }\n\t\t * }\n\t\t * ```\n\t\t */\n\t\tclearEffects() {\n\t\t\tthis.stopEffects()\n\t\t\tthis.#effectFunctions = []\n\t\t}\n\n\t\t#owner: Owner | null = null\n\t\t#dispose: (() => void) | null = null\n\n\t\t#createEffect(fn: () => void) {\n\t\t\tconst owner = getOwner()\n\n\t\t\t// If nested in an existing owner (f.e. nested effect), delegate to\n\t\t\t// regular createEffect.\n\t\t\tif (owner) return createEffect(fn)\n\n\t\t\t// Store top-level effect functions so they can be replayed when\n\t\t\t// startEffects() is called\n\t\t\tif (!this.#isRestarting) this.#effectFunctions.push(fn)\n\n\t\t\t// If top-level call either attach to an existing root, or make a\n\t\t\t// new one if we don't have one yet.\n\t\t\tif (this.#owner) runWithOwner(this.#owner, () => createEffect(fn))\n\t\t\telse {\n\t\t\t\tcreateRoot(dispose => {\n\t\t\t\t\tthis.#owner = getOwner()\n\t\t\t\t\tthis.#dispose = () => {\n\t\t\t\t\t\tdispose()\n\t\t\t\t\t\tthis.#owner = null\n\t\t\t\t\t}\n\t\t\t\t\tcreateEffect(fn)\n\t\t\t\t})\n\t\t\t}\n\t\t}\n\t}\n\n\t;(EffectfulClass.prototype as any)[isInstance] = true\n\n\tObject.defineProperty(EffectfulClass, Symbol.hasInstance, {value: instanceCheck})\n\n\treturn EffectfulClass\n}\n\nObject.defineProperty(Effectful, Symbol.hasInstance, {value: instanceCheck})\n\nfunction instanceCheck(obj: any): boolean {\n\tif (!obj || typeof obj !== 'object') return false\n\treturn isInstance in obj\n}\n\n/**\n * Shortcut for instantiating or extending directly instead of using the mixin.\n * F.e.\n *\n * ```js\n * class Car extends Effects {\n *   start() {\n *     this.createEffect(() => {...})\n *     this.createEffect(() => {...})\n *   }\n *   stop() {\n *     this.stopEffects()\n *   }\n * }\n *\n * const specialEffects = new Effects()\n * specialEffects.createEffect(() => {})\n * // ...later\n * specialEffects.stopEffects()\n * ```\n */\nexport class Effects extends Effectful(class {}) {}\n"],"mappings":"AAAA,SAAoBA,YAAY,EAAEC,UAAU,EAAEC,QAAQ,EAAEC,YAAY,QAAO,UAAU;AAGrF,MAAMC,UAAU,GAAGC,MAAM,CAAC,CAAC;;AAE3B;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,OAAO,SAASC,SAASA,CAA2BC,IAAO,EAAE;EAC5D,IAAIA,IAAI,CAACC,SAAS,YAAYF,SAAS,EACtC,MAAM,IAAIG,KAAK,CAAC,oEAAoE,CAAC;EAEtF,MAAMC,cAAc,SAASH,IAAI,CAAC;IACjC,CAACI,eAAe,GAAsB,EAAE;IACxC,CAACC,OAAO,GAAG,IAAI;;IAEf;AACF;AACA;AACA;AACA;IACEZ,YAAYA,CAACa,EAAc,EAAE;MAC5B,IAAI,CAACC,YAAY,CAAC,CAAC;MACnB,IAAI,CAAC,CAACd,YAAY,CAACa,EAAE,CAAC;IACvB;;IAEA;AACF;AACA;AACA;AACA;AACA;AACA;AACA;IACEE,WAAWA,CAACF,EAAc,EAAE;MAC3B,IAAI,CAAC,CAACF,eAAe,CAACK,IAAI,CAACH,EAAE,CAAC;IAC/B;IAEA,CAACI,YAAY,GAAG,KAAK;;IAErB;AACF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;IACEH,YAAYA,CAAA,EAAG;MACd,IAAI,IAAI,CAAC,CAACF,OAAO,EAAE;MACnB,IAAI,CAAC,CAACA,OAAO,GAAG,IAAI;;MAEpB;MACA,IAAI,CAAC,CAACK,YAAY,GAAG,IAAI;MACzB,IAAI;QACH,KAAK,MAAMJ,EAAE,IAAI,IAAI,CAAC,CAACF,eAAe,EAAE,IAAI,CAAC,CAACX,YAAY,CAACa,EAAE,CAAC;MAC/D,CAAC,SAAS;QACT,IAAI,CAAC,CAACI,YAAY,GAAG,KAAK;MAC3B;IACD;;IAEA;AACF;AACA;IACEC,WAAWA,CAAA,EAAG;MACb,IAAI,CAAC,IAAI,CAAC,CAACN,OAAO,EAAE;MACpB,IAAI,CAAC,CAACA,OAAO,GAAG,KAAK;MAErB,IAAI,CAAC,CAACO,OAAO,GAAG,CAAC;IAClB;;IAEA;AACF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;IACEC,YAAYA,CAAA,EAAG;MACd,IAAI,CAACF,WAAW,CAAC,CAAC;MAClB,IAAI,CAAC,CAACP,eAAe,GAAG,EAAE;IAC3B;IAEA,CAACU,KAAK,GAAiB,IAAI;IAC3B,CAACF,OAAO,GAAwB,IAAI;IAEpC,CAACnB,YAAYsB,CAACT,EAAc,EAAE;MAC7B,MAAMQ,KAAK,GAAGnB,QAAQ,CAAC,CAAC;;MAExB;MACA;MACA,IAAImB,KAAK,EAAE,OAAOrB,YAAY,CAACa,EAAE,CAAC;;MAElC;MACA;MACA,IAAI,CAAC,IAAI,CAAC,CAACI,YAAY,EAAE,IAAI,CAAC,CAACN,eAAe,CAACK,IAAI,CAACH,EAAE,CAAC;;MAEvD;MACA;MACA,IAAI,IAAI,CAAC,CAACQ,KAAK,EAAElB,YAAY,CAAC,IAAI,CAAC,CAACkB,KAAK,EAAE,MAAMrB,YAAY,CAACa,EAAE,CAAC,CAAC,MAC7D;QACJZ,UAAU,CAACkB,OAAO,IAAI;UACrB,IAAI,CAAC,CAACE,KAAK,GAAGnB,QAAQ,CAAC,CAAC;UACxB,IAAI,CAAC,CAACiB,OAAO,GAAG,MAAM;YACrBA,OAAO,CAAC,CAAC;YACT,IAAI,CAAC,CAACE,KAAK,GAAG,IAAI;UACnB,CAAC;UACDrB,YAAY,CAACa,EAAE,CAAC;QACjB,CAAC,CAAC;MACH;IACD;EACD;EAEA;EAAEH,cAAc,CAACF,SAAS,CAASJ,UAAU,CAAC,GAAG,IAAI;EAErDmB,MAAM,CAACC,cAAc,CAACd,cAAc,EAAEL,MAAM,CAACoB,WAAW,EAAE;IAACC,KAAK,EAAEC;EAAa,CAAC,CAAC;EAEjF,OAAOjB,cAAc;AACtB;AAEAa,MAAM,CAACC,cAAc,CAAClB,SAAS,EAAED,MAAM,CAACoB,WAAW,EAAE;EAACC,KAAK,EAAEC;AAAa,CAAC,CAAC;AAE5E,SAASA,aAAaA,CAACC,GAAQ,EAAW;EACzC,IAAI,CAACA,GAAG,IAAI,OAAOA,GAAG,KAAK,QAAQ,EAAE,OAAO,KAAK;EACjD,OAAOxB,UAAU,IAAIwB,GAAG;AACzB;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,OAAO,MAAMC,OAAO,SAASvB,SAAS,CAAC,MAAM,EAAE,CAAC,CAAC","ignoreList":[]}