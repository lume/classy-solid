{"version":3,"file":"signalify.js","names":["getInheritedDescriptor","createSignal","$PROXY","signalifiedProps","WeakMap","signalify","obj","props","_props","length","Object","keys","concat","getOwnPropertySymbols","prop","createSignalAccessor","gotCreateSignalAccessor","getCreateSignalAccessor","Error","initialVal","get","has","proxy","descriptor","originalGet","originalSet","set","console","warn","toString","writable","value","configurable","enumerable","s","getSignal","call","newValue","__propsSetAtLeastOnce__","Set","add","v","defineProperty","signals","instance","signalKey","initialValue","undefined","Map","equals"],"sources":["../src/signalify.ts"],"sourcesContent":["import {getInheritedDescriptor} from 'lowclass'\nimport {createSignal, $PROXY} from 'solid-js'\nimport type {Signal} from 'solid-js/types/reactive/signal'\nimport type {PropKey, PropSpec} from './decorators/types.js'\n\nconst signalifiedProps = new WeakMap<object, Set<string | symbol>>()\n\n/**\n * Convert properties on an object into Solid signal-backed properties.\n *\n * There are two ways to use this: either by defining which properties to\n * convert to signal-backed properties by providing an array as property names\n * in the second arg, which is useful on plain objects, or by passing in `this`\n * and `this.constructor` within the `constructor` of a class that has\n * properties decorated with `@signal`.\n *\n * Example with a class:\n *\n * ```js\n * import {signalify} from 'classy-solid'\n * import {createEffect} from 'solid-js'\n *\n * class Counter {\n *   count = 0\n *\n *   constructor() {\n *     signalify(this, 'count')\n *     setInterval(() => this.count++, 1000)\n *   }\n * }\n *\n * const counter = new Counter\n *\n * createEffect(() => {\n *   console.log('count:', counter.count)\n * })\n * ```\n *\n * Example with a plain object:\n *\n * ```js\n * import {signalify} from 'classy-solid'\n * import {createEffect} from 'solid-js'\n *\n * const counter = {\n *   count: 0\n * }\n *\n * signalify(counter, 'count')\n * setInterval(() => counter.count++, 1000)\n *\n * createEffect(() => {\n *   console.log('count:', counter.count)\n * })\n * ```\n */\nexport function signalify<T extends object>(obj: T, ...props: (keyof T)[]): T\nexport function signalify<T extends object, K extends keyof T>(obj: T): T\nexport function signalify(obj: Obj, ...props: [] | [Map<PropKey, PropSpec>] | PropertyKey[]) {\n\t// We cast from PropertyKey[] to PropKey[] because numbers can't actually be keys, only string | symbol.\n\tconst _props = props.length\n\t\t? (props as PropKey[])\n\t\t: (Object.keys(obj) as PropKey[]).concat(Object.getOwnPropertySymbols(obj))\n\n\tfor (const prop of _props) createSignalAccessor(obj, prop)\n\n\treturn obj\n}\n\nlet gotCreateSignalAccessor = false\n\n/**\n * This ensures that `createSignalAccessor` is kept internal to classy-solid only.\n */\nexport function getCreateSignalAccessor() {\n\tif (gotCreateSignalAccessor) throw new Error('Export \"createSignalAccessor\" is internal to classy-solid only.')\n\tgotCreateSignalAccessor = true\n\treturn createSignalAccessor\n}\n\nfunction createSignalAccessor<T extends object>(\n\tobj: T,\n\tprop: Exclude<keyof T, number>,\n\tinitialVal: unknown = obj[prop],\n): void {\n\tif (signalifiedProps.get(obj)?.has(prop)) return\n\n\t// Special case for Solid proxies: if the object is already a solid proxy,\n\t// all properties are already reactive, no need to signalify.\n\t// @ts-expect-error special indexed access\n\tconst proxy = obj[$PROXY] as T\n\tif (proxy) return\n\n\t// XXX If obj already has a signal, skip making an accessor? I think perhaps\n\t// not, because a subclass might override a property so it is not reactive,\n\t// and a further subclass might want to make it reactive again in which\n\t// case returning early would cause the subclass subclass's property not to\n\t// be reactive.\n\t// if (signals.get(obj)?.get(propName) !== undefined) return\n\n\tlet descriptor: PropertyDescriptor | undefined = getInheritedDescriptor(obj, prop)\n\n\tlet originalGet: (() => any) | undefined\n\tlet originalSet: ((v: any) => void) | undefined\n\n\t// TODO if there is an inherited accessor, we need to ensure we still call\n\t// it so that we're extending instead of overriding. Otherwise placing\n\t// @reactive on a property will break that functionality in those cases.\n\t//\n\t// Right now, originalGet will only be called if it is on the current\n\t// prototype, but we aren't checking for any accessor that may be inherited.\n\n\tif (descriptor) {\n\t\toriginalGet = descriptor.get\n\t\toriginalSet = descriptor.set\n\n\t\tif (originalGet || originalSet) {\n\t\t\t// reactivity requires both\n\t\t\tif (!originalGet || !originalSet) {\n\t\t\t\tconsole.warn(\n\t\t\t\t\t`The \\`@signal\\` decorator was used on an accessor named \"${prop.toString()}\" which had a getter or a setter, but not both. Reactivity on accessors works only when accessors have both get and set. In this case the decorator does not do anything.`,\n\t\t\t\t)\n\t\t\t\treturn\n\t\t\t}\n\n\t\t\tdelete descriptor.get\n\t\t\tdelete descriptor.set\n\t\t} else {\n\t\t\t// initialValue = descriptor.value\n\n\t\t\t// if it isn't writable, we don't need to make a reactive variable because\n\t\t\t// the value won't change\n\t\t\tif (!descriptor.writable) {\n\t\t\t\tconsole.warn(\n\t\t\t\t\t`The \\`@signal\\` decorator was used on a property named \"${prop.toString()}\" that is not writable. Reactivity is not enabled for non-writable properties.`,\n\t\t\t\t)\n\t\t\t\treturn\n\t\t\t}\n\n\t\t\tdelete descriptor.value\n\t\t\tdelete descriptor.writable\n\t\t}\n\t}\n\n\tdescriptor = {\n\t\tconfigurable: true,\n\t\tenumerable: true,\n\t\t...descriptor,\n\t\tget: originalGet\n\t\t\t? function (this: T): unknown {\n\t\t\t\t\tconst s = getSignal(this, prop, initialVal)\n\t\t\t\t\ts[0]() // read\n\t\t\t\t\treturn originalGet!.call(this)\n\t\t\t  }\n\t\t\t: function (this: any): unknown {\n\t\t\t\t\tconst s = getSignal(this, prop, initialVal)\n\t\t\t\t\treturn s[0]() // read\n\t\t\t  },\n\t\tset: originalSet\n\t\t\t? function (this: any, newValue: unknown) {\n\t\t\t\t\toriginalSet!.call(this, newValue)\n\n\t\t\t\t\t// __propsSetAtLeastOnce__ is a Set that tracks which reactive\n\t\t\t\t\t// properties have been set at least once. @lume/element uses this\n\t\t\t\t\t// to detect if a reactive prop has been set, and if so will not\n\t\t\t\t\t// overwrite the value with any value from custom element\n\t\t\t\t\t// pre-upgrade.\n\t\t\t\t\tif (!this.__propsSetAtLeastOnce__) this.__propsSetAtLeastOnce__ = new Set<string>()\n\t\t\t\t\tthis.__propsSetAtLeastOnce__.add(prop)\n\n\t\t\t\t\tconst v = getSignal(this, prop)\n\t\t\t\t\t// write\n\t\t\t\t\tif (typeof newValue === 'function') v[1](() => newValue)\n\t\t\t\t\telse v[1](newValue)\n\t\t\t  }\n\t\t\t: function (this: any, newValue: unknown) {\n\t\t\t\t\tif (!this.__propsSetAtLeastOnce__) this.__propsSetAtLeastOnce__ = new Set<string>()\n\t\t\t\t\tthis.__propsSetAtLeastOnce__.add(prop)\n\n\t\t\t\t\tconst v = getSignal(this, prop)\n\t\t\t\t\t// write\n\t\t\t\t\tif (typeof newValue === 'function') v[1](() => newValue)\n\t\t\t\t\telse v[1](newValue)\n\t\t\t  },\n\t}\n\n\tObject.defineProperty(obj, prop, descriptor)\n\n\tif (!signalifiedProps.has(obj)) signalifiedProps.set(obj, new Set())\n\tsignalifiedProps.get(obj)!.add(prop)\n}\n\nconst signals = new WeakMap<object, Map<PropKey, Signal<unknown>>>()\n\nfunction getSignal<T>(instance: object, signalKey: PropKey, initialValue: T = undefined!): Signal<T> {\n\tif (!signals.has(instance)) signals.set(instance, new Map())\n\n\tlet s = signals.get(instance)!.get(signalKey) as Signal<T> | undefined\n\n\tif (s) return s\n\n\ts = createSignal<T>(initialValue, {equals: false})\n\tsignals.get(instance)?.set(signalKey, s as Signal<unknown>)\n\n\treturn s\n}\n\ntype Obj = Record<PropKey, unknown>\n"],"mappings":"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"}