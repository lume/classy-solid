{"version":3,"file":"_state.js","names":["memoify","isSignalGetter","WeakSet","isMemoGetter","isSorted","typeOrder","getSignalsAndMemos","metadata","Object","hasOwn","signalFieldsAndMemos","sortSignalsMemosInMetadata","has","add","sort","a","b","type","getMemberStat","name","signalsAndMemos","stat","find","key","push","applied","WeakMap","memoifyIfNeeded","obj","isAutoAccessor","get","set","isPriorSignalOrMemoDefined","finalizeMemos","last","findLast","_","lastStat"],"sources":["../../src/signals/_state.ts"],"sourcesContent":["import type {PropKey, SignalMetadata, SignalOrMemoType} from '../decorators/types.js'\nimport {memoify} from './memoify.js'\n\nexport const isSignalGetter = new WeakSet<Function>()\nexport const isMemoGetter = new WeakSet<Function>()\n\nconst isSorted = new WeakSet<SignalMetadata>()\n\nconst typeOrder = {'signal-field': 0, 'memo-field': 1, 'memo-auto-accessor': 1, 'memo-accessor': 2, 'memo-method': 2}\n\nexport function getSignalsAndMemos(metadata: SignalMetadata) {\n\tif (!Object.hasOwn(metadata, 'signalFieldsAndMemos')) metadata.signalFieldsAndMemos = []\n\treturn metadata.signalFieldsAndMemos!\n}\n\n/**\n * Sort certain members tracked in metadata in the order of\n *\n * 1. signal fields\n * 2. memo fields\n * 3. memo auto-accessors\n * 4. memo accessors\n * 5. memo methods\n *\n * so that any members that are normally initialized *after*\n * getters/setters/methods (fields and accessors, such as signal fields, and\n * memo fields and auto-accessors) will be initialized before\n * getters/setters/methods (memo accessors and methods).\n *\n * This ensures proper initialization order which we cannot currently achieve\n * with the default ordering of EcmaScript decorators alone.\n */\nexport function sortSignalsMemosInMetadata(metadata: SignalMetadata) {\n\tif (!metadata.signalFieldsAndMemos) return\n\n\tif (isSorted.has(metadata)) return\n\tisSorted.add(metadata)\n\n\t// Sort so that signal fields come first, then memo fields and\n\t// auto-accessors, finally memo accessors and methods.\n\tmetadata.signalFieldsAndMemos.sort((a, b) => typeOrder[a[1].type] - typeOrder[b[1].type])\n}\n\nexport function getMemberStat(name: PropKey, type: SignalOrMemoType, signalsAndMemos: any[]) {\n\tlet stat = signalsAndMemos.find(([key]) => key === name)?.[1]\n\tif (!stat) signalsAndMemos.push([name, (stat = {type, applied: new WeakMap()})])\n\treturn stat\n}\n\nexport function memoifyIfNeeded(obj: object, name: PropKey, stat: any, isAutoAccessor = false) {\n\tif (stat.applied.get(obj)) return\n\tisAutoAccessor ? memoify(obj, true, name as keyof typeof obj) : memoify(obj, name as keyof typeof obj)\n\tstat.applied.set(obj, true)\n}\n\n/**\n * If any signal-fields, memo-fields, or memo-auto-accessors are defined on the\n * class (thus sorted before the given memo field), skip memoifying now (true\n * return). We'll memoify later after signal fields are initialized.\n */\nexport function isPriorSignalOrMemoDefined(obj: object, name: PropKey, signalsAndMemos: any[]) {\n\tfor (const [key, stat] of signalsAndMemos) {\n\t\tif (\n\t\t\t(stat.type === 'signal-field' || stat.type === 'memo-field' || stat.type === 'memo-auto-accessor') &&\n\t\t\t!stat.applied.get(obj)\n\t\t)\n\t\t\treturn true\n\t\tif (key === name) break // reached our own memo field, no prior signal-fields or memo-auto-accessors found\n\t}\n\treturn false\n}\n\n/**\n * This finalizes memo initialization for memo accessors and methods that\n * were waiting for all signal fields, memo fields, and memo auto-accessors\n * to be initialized first.\n *\n * Basically we ensure that memo initialization happens in this order:\n * 1. signal fields\n * 2. memo fields\n * 3. memo auto-accessors\n * 4. memo accessors\n * 5. memo methods\n *\n * This is important because memos may depend on signals or other memos, and we\n * cannot rely on EcmaScript decorator application order alone, since accessor\n * and method before field decorators no matter the order in source code.\n *\n * See: https://github.com/tc39/proposal-decorators/issues/566\n */\nexport function finalizeMemos(obj: object, stat: any, signalsAndMemos: any[]) {\n\tconst last = signalsAndMemos.findLast(\n\t\t([_, {type}]) => type === 'signal-field' || type === 'memo-field' || type === 'memo-auto-accessor',\n\t)!\n\tconst [, lastStat] = last\n\n\tif (stat !== lastStat) return\n\n\t// All signal-fields, memo-fields, and memo-auto-accessors have been\n\t// initialized. Now initialize memo fields that were waiting for\n\t// those to be ready.\n\tfor (const [key, stat] of signalsAndMemos) {\n\t\tif (!(stat.type === 'memo-accessor' || stat.type === 'memo-method') || stat.applied.get(obj)) continue\n\n\t\tmemoifyIfNeeded(obj, key, stat)\n\t}\n}\n"],"mappings":"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","ignoreList":[]}