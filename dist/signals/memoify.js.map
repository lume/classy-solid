{"version":3,"file":"memoify.js","names":["createMemo","createWritableMemo","getInheritedDescriptor","isMemoGetter","isSignalGetter","Undefined","Symbol","memoify","obj","propOrBoolean","props","isAutoAccessor","keys","length","Object","getOwnPropertySymbols","key","descriptor","get","has","value","fn","call","name","String","val","Error","set","defineProperty","configurable","enumerable","add"],"sources":["../../src/signals/memoify.ts"],"sourcesContent":["import {createMemo} from 'solid-js'\nimport {createWritableMemo} from '@solid-primitives/memo'\nimport {getInheritedDescriptor} from 'lowclass/dist/getInheritedDescriptor.js'\nimport {isMemoGetter, isSignalGetter} from './_state.js'\n\ntype AnyObject = Record<PropertyKey, unknown>\n\nconst Undefined = Symbol()\n\n/**\n * Convert properties on an object into Solid.js memoized properties.\n *\n * There are two ways to use this:\n *\n * 1. Define which properties to convert to memoized properties by providing\n * property names as trailing arguments. Properties that are not function-valued\n * or accessors will be ignored.\n * 2. If no property names are provided, all function-valued properties and\n * accessors on the object will be automatically converted to memoized\n * properties.\n *\n * If any property is already memoified with `memoify()`, or already signalified\n * with `signalify()`, it will be skipped.\n *\n * Example with a plain object:\n *\n * ```js\n * import {memoify, signalify} from 'classy-solid'\n * import {createEffect} from 'solid-js'\n *\n * const obj = {\n *   a: 1,\n *   b: 2,\n *   get sum() {\n *     return this.a + this.b\n *   }\n * }\n *\n * signalify(obj, 'a', 'b')\n * memoify(obj, 'sum')\n *\n * createEffect(() => {\n *   console.log('sum:', obj.sum)\n * })\n *\n * obj.a = 3 // updates sum to 5\n * ```\n *\n * Example with a class:\n *\n * ```js\n * import {memoify, signalify} from 'classy-solid'\n * import {createEffect} from 'solid-js'\n *\n * class Example {\n *   a = 1\n *   b = 2\n *\n *   get sum() {\n *     return this.a + this.b\n *   }\n *\n *   constructor() {\n *     signalify(this, 'a', 'b')\n *     memoify(this, 'sum')\n *   }\n * }\n *\n * const ex = new Example()\n *\n * createEffect(() => {\n *   console.log('sum:', ex.sum)\n * })\n *\n * ex.a = 3 // updates sum to 5\n * ```\n */\nexport function memoify<T extends object, K extends keyof T>(obj: T): T\nexport function memoify<T extends object>(obj: T, ...props: (keyof T)[]): T\n/** This overload is for use by the @memo decorator */\nexport function memoify<T extends object>(obj: T, isAutoAccessor: boolean, ...props: (keyof T)[]): T\nexport function memoify(obj: AnyObject, propOrBoolean?: PropertyKey | boolean, ...props: PropertyKey[]) {\n\tconst isAutoAccessor = typeof propOrBoolean === 'boolean' ? propOrBoolean : false\n\n\tprops =\n\t\ttypeof propOrBoolean === 'boolean'\n\t\t\t? props\n\t\t\t: typeof propOrBoolean !== 'undefined'\n\t\t\t? [propOrBoolean, ...props]\n\t\t\t: props\n\n\t// If no props specified, use all keys (including symbols)\n\tconst keys: PropertyKey[] = props.length ? props : [...Object.keys(obj), ...Object.getOwnPropertySymbols(obj)]\n\n\tfor (const key of keys) {\n\t\tconst descriptor = getInheritedDescriptor(obj, key)\n\n\t\tif (!descriptor) continue\n\n\t\t// Skip if already memoified or signalified\n\t\tif (descriptor.get && (isMemoGetter.has(descriptor.get) || isSignalGetter.has(descriptor.get))) continue\n\n\t\t// Handle methods (function-valued properties)\n\t\tif (typeof descriptor.value === 'function' || isAutoAccessor) {\n\t\t\tconst fn = isAutoAccessor ? descriptor.get?.call(obj) : descriptor.value\n\t\t\tif (typeof fn !== 'function') continue\n\n\t\t\tconst name = fn.name || String(key)\n\t\t\tlet value\n\n\t\t\t// Readonly memo: arity 0\n\t\t\tif (fn.length === 0) {\n\t\t\t\tconst get = createMemo(() => fn.call(obj))\n\n\t\t\t\tvalue = (val = Undefined) => {\n\t\t\t\t\tif (val === Undefined) return get()\n\t\t\t\t\tthrow new Error(`Cannot set readonly memoized method \"${String(key)}\".`)\n\t\t\t\t}\n\t\t\t}\n\t\t\t// Writable memo: arity > 0\n\t\t\telse {\n\t\t\t\tconst [get, set] = createWritableMemo(() => fn.call(obj))\n\n\t\t\t\tvalue = (val: unknown = Undefined) => {\n\t\t\t\t\tif (val === Undefined) return get()\n\t\t\t\t\tset(typeof val === 'function' ? () => val : val)\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tObject.defineProperty(value, 'name', {value: name, configurable: true})\n\t\t\tObject.defineProperty(obj, key, {value, configurable: true, enumerable: descriptor.enumerable})\n\t\t\tisMemoGetter.add(value)\n\t\t}\n\n\t\t// Handle accessors\n\t\telse if (descriptor.get) {\n\t\t\tlet get\n\t\t\tlet set: ((val: unknown) => void) | undefined\n\n\t\t\t// Readonly memo: getter only\n\t\t\tif (!descriptor.set) get = createMemo(() => descriptor.get!.call(obj))\n\t\t\t// Writable memo: getter and setter\n\t\t\telse [get, set] = createWritableMemo(() => descriptor.get!.call(obj))\n\n\t\t\tObject.defineProperty(get, 'name', {value: String(key), configurable: true})\n\t\t\tif (set) Object.defineProperty(set, 'name', {value: String(key), configurable: true})\n\t\t\tObject.defineProperty(obj, key, {\n\t\t\t\tget,\n\t\t\t\tset: set && (val => (typeof val === 'function' ? set(() => val) : set(val))),\n\t\t\t\tconfigurable: true,\n\t\t\t\tenumerable: descriptor.enumerable,\n\t\t\t})\n\t\t\tisMemoGetter.add(get)\n\t\t}\n\n\t\t// Skip non-function, non-accessor properties\n\t\tcontinue\n\t}\n\n\treturn obj\n}\n"],"mappings":"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","ignoreList":[]}