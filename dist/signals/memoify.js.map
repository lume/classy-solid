{"version":3,"file":"memoify.js","names":["createMemo","createWritableMemo","getInheritedDescriptor","isMemoGetter__","isSignalGetter__","Undefined","Symbol","memberStat","setMemoifyMemberStat","stat","memoify","obj","props","keys","length","Object","getOwnPropertySymbols","isAutoAccessor","type","key","descriptor","get","has","value","leafmostMemberValue","fn","call","Error","String","name","val","set","defineProperty","configurable","enumerable","add"],"sources":["../../src/signals/memoify.ts"],"sourcesContent":["import {createMemo} from 'solid-js'\nimport {createWritableMemo} from '@solid-primitives/memo'\nimport {getInheritedDescriptor} from 'lowclass/dist/getInheritedDescriptor.js'\nimport {isMemoGetter__, isSignalGetter__} from '../_state.js'\nimport type {AnyObject, MemberStat} from '../decorators/types.js'\n\nconst Undefined = Symbol()\n\nlet memberStat: MemberStat | null = null\n\n/** @private internal only */\nexport function setMemoifyMemberStat(stat: MemberStat) {\n\tmemberStat = stat\n}\n\n/**\n * Convert properties on an object into Solid.js memoized properties.\n *\n * There are two ways to use this:\n *\n * 1. Define which properties to convert to memoized properties by providing\n * property names as trailing arguments. Properties that are not function-valued\n * or accessors will be ignored.\n * 2. If no property names are provided, all function-valued properties and\n * accessors on the object will be automatically converted to memoized\n * properties.\n *\n * If any property is already memoified with `memoify()`, or already signalified\n * with `signalify()`, it will be skipped.\n *\n * Example with a plain object:\n *\n * ```js\n * import {memoify, signalify} from 'classy-solid'\n * import {createEffect} from 'solid-js'\n *\n * const obj = {\n *   a: 1,\n *   b: 2,\n *   get sum() {\n *     return this.a + this.b\n *   }\n * }\n *\n * signalify(obj, 'a', 'b')\n * memoify(obj, 'sum')\n *\n * createEffect(() => {\n *   console.log('sum:', obj.sum)\n * })\n *\n * obj.a = 3 // updates sum to 5\n * ```\n *\n * Example with a class:\n *\n * ```js\n * import {memoify, signalify} from 'classy-solid'\n * import {createEffect} from 'solid-js'\n *\n * class Example {\n *   a = 1\n *   b = 2\n *\n *   get sum() {\n *     return this.a + this.b\n *   }\n *\n *   constructor() {\n *     signalify(this, 'a', 'b')\n *     memoify(this, 'sum')\n *   }\n * }\n *\n * const ex = new Example()\n *\n * createEffect(() => {\n *   console.log('sum:', ex.sum)\n * })\n *\n * ex.a = 3 // updates sum to 5\n * ```\n */\nexport function memoify<T extends object, K extends keyof T>(obj: T): T\nexport function memoify<T extends object>(obj: T, ...props: (keyof T)[]): T\nexport function memoify(obj: AnyObject, ...props: PropertyKey[]) {\n\t// If no props specified, use all keys (including symbols)\n\tconst keys: PropertyKey[] = props.length ? props : [...Object.keys(obj), ...Object.getOwnPropertySymbols(obj)]\n\n\tconst isAutoAccessor = memberStat?.type === 'memo-auto-accessor'\n\n\tfor (const key of keys) {\n\t\tconst descriptor = getInheritedDescriptor(obj, key)\n\n\t\tif (!descriptor) {\n\t\t\tmemberStat = null\n\t\t\tcontinue\n\t\t}\n\n\t\t// Skip if already memoified or signalified\n\t\tif (descriptor.get && (isMemoGetter__.has(descriptor.get) || isSignalGetter__.has(descriptor.get))) {\n\t\t\tmemberStat = null\n\t\t\tcontinue\n\t\t}\n\n\t\t// Handle methods (function-valued properties)\n\t\tif (typeof descriptor.value === 'function' || isAutoAccessor) {\n\t\t\t// Skip base class memoify if a subclass is overriding an auto-accessor memo.\n\t\t\tconst leafmostMemberValue = isAutoAccessor ? descriptor.get : descriptor.value\n\t\t\tif (memberStat && leafmostMemberValue !== memberStat!.value) {\n\t\t\t\tmemberStat = null\n\t\t\t\tcontinue\n\t\t\t}\n\n\t\t\tconst fn = isAutoAccessor ? descriptor.get?.call(obj) : descriptor.value\n\n\t\t\tif (typeof fn !== 'function') {\n\t\t\t\t// Throw in decorator mode only.\n\t\t\t\tif (memberStat) {\n\t\t\t\t\tmemberStat = null\n\t\t\t\t\tthrow new Error(`memo value for \"${String(key)}\" is not a function: ${fn}`)\n\t\t\t\t}\n\t\t\t\t// Otherwise just skip non-function properties (f.e. using memoify(obj) directly on a plain object, without decorators).\n\t\t\t\telse continue\n\t\t\t}\n\n\t\t\tconst name = fn.name || String(key)\n\t\t\tlet value\n\n\t\t\t// Readonly memo: arity 0\n\t\t\tif (fn.length === 0) {\n\t\t\t\tconst get = createMemo(() => fn.call(obj))\n\n\t\t\t\tvalue = (val = Undefined) => {\n\t\t\t\t\tif (val === Undefined) return get()\n\t\t\t\t\tthrow new Error(`Cannot set readonly memoized method \"${String(key)}\".`)\n\t\t\t\t}\n\t\t\t}\n\t\t\t// Writable memo: arity > 0\n\t\t\telse {\n\t\t\t\tconst [get, set] = createWritableMemo(() => fn.call(obj))\n\n\t\t\t\tvalue = (val: unknown = Undefined) => {\n\t\t\t\t\tif (val === Undefined) return get()\n\t\t\t\t\tset(typeof val === 'function' ? () => val : val)\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tObject.defineProperty(value, 'name', {value: name, configurable: true})\n\t\t\tObject.defineProperty(obj, key, {value, configurable: true, enumerable: descriptor.enumerable})\n\t\t\tisMemoGetter__.add(value)\n\t\t}\n\n\t\t// Handle accessors\n\t\telse if (descriptor.get || descriptor.set) {\n\t\t\tif (!descriptor.get) {\n\t\t\t\tmemberStat = null\n\t\t\t\tthrow new Error(`Cannot memoify accessor \"${String(key)}\" without a getter.`)\n\t\t\t}\n\t\t\tlet get\n\t\t\tlet set: ((val: unknown) => void) | undefined\n\n\t\t\t// Readonly memo: getter only\n\t\t\tif (!descriptor.set) get = createMemo(() => descriptor.get!.call(obj))\n\t\t\t// Writable memo: getter and setter\n\t\t\telse [get, set] = createWritableMemo(() => descriptor.get!.call(obj))\n\n\t\t\tObject.defineProperty(get, 'name', {value: String(key), configurable: true})\n\t\t\tif (set) Object.defineProperty(set, 'name', {value: String(key), configurable: true})\n\t\t\tObject.defineProperty(obj, key, {\n\t\t\t\tget,\n\t\t\t\tset: set && (val => (typeof val === 'function' ? set(() => val) : set(val))),\n\t\t\t\tconfigurable: true,\n\t\t\t\tenumerable: descriptor.enumerable,\n\t\t\t})\n\t\t\tisMemoGetter__.add(get)\n\t\t} else {\n\t\t\t// Throw in decorator mode only.\n\t\t\tif (memberStat) {\n\t\t\t\tmemberStat = null\n\t\t\t\tthrow new Error(`memo value for \"${String(key)}\" is not a function: ${descriptor.value}`)\n\t\t\t}\n\t\t}\n\t}\n\n\tmemberStat = null\n\n\treturn obj\n}\n"],"mappings":"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","ignoreList":[]}